{% extends "base.html" %}

{% block title %}Workshop: {{ playlist.name }} - Shuffify{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-spotify-green via-spotify-green/90 to-spotify-dark">
    <div class="absolute inset-0" style="background-image: url('/static/images/hero-pattern.svg'); opacity: 0.15; pointer-events: none;"></div>

    <!-- Workshop Header -->
    <div class="relative max-w-5xl mx-auto px-4 pt-8">
        <div class="p-6 rounded-2xl shadow-xl backdrop-blur-md bg-white/10 border border-white/20">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center min-w-0">
                    <a href="{{ url_for('main.index') }}"
                       class="mr-4 p-2 rounded-lg bg-white/10 hover:bg-white/20 transition duration-150 border border-white/20 flex-shrink-0"
                       title="Back to Dashboard">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </a>
                    <div class="min-w-0">
                        <h1 class="text-2xl font-bold text-white truncate">{{ playlist.name }}</h1>
                        <p class="text-white/70 text-sm">
                            <span id="track-count">{{ playlist.tracks|length }}</span> tracks
                            <span id="modified-badge" class="ml-2 px-2 py-0.5 rounded-full bg-yellow-500/80 text-xs font-semibold hidden">Modified</span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 flex-shrink-0">
                    <button id="undo-preview-btn"
                            onclick="undoPreview()"
                            class="hidden inline-flex items-center px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white font-medium transition duration-150 border border-white/20"
                            title="Revert to last saved order">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a5 5 0 015 5v2M3 10l4-4M3 10l4 4"></path>
                        </svg>
                        Undo Changes
                    </button>
                    <button id="save-btn"
                            onclick="commitToSpotify()"
                            disabled
                            class="inline-flex items-center px-6 py-2 rounded-lg bg-white text-spotify-dark font-bold transition duration-150 hover:bg-green-100 disabled:opacity-40 disabled:cursor-not-allowed shadow-lg"
                            title="Save current order to Spotify">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Save to Spotify
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Workshop Area -->
    <div class="relative max-w-5xl mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Track List (2/3 width on large screens) -->
            <div class="lg:col-span-2">
                <div class="rounded-2xl shadow-xl backdrop-blur-md bg-white/10 border border-white/20 overflow-hidden">
                    <!-- Track List Header -->
                    <div class="px-4 py-3 border-b border-white/10 flex items-center text-white/60 text-xs uppercase tracking-wide font-semibold">
                        <span class="w-10 text-center">#</span>
                        <span class="w-10"></span>
                        <span class="flex-1 ml-3">Title</span>
                        <span class="w-24 text-right hidden sm:block">Duration</span>
                        <span class="w-8"></span>
                        <span class="w-8"></span>
                    </div>

                    <!-- Scrollable Track List -->
                    <div id="track-list" class="max-h-[65vh] overflow-y-auto workshop-scrollbar">
                        <!-- Empty state -->
                        {% if not playlist.tracks %}
                        <div class="p-8 text-center text-white/60">
                            <p class="text-lg">This playlist has no tracks.</p>
                            <a href="{{ url_for('main.index') }}" class="text-white underline mt-2 inline-block">Back to Dashboard</a>
                        </div>
                        {% endif %}

                        {% for track in playlist.tracks %}
                        <div class="track-item flex items-center px-4 py-2 hover:bg-white/5 transition duration-150 border-b border-white/5 cursor-grab active:cursor-grabbing"
                             data-uri="{{ track.uri }}"
                             data-track-id="{{ track.id }}">
                            <!-- Track Number -->
                            <span class="track-number w-10 text-center text-white/50 text-sm font-mono">{{ loop.index }}</span>

                            <!-- Album Art -->
                            <div class="w-10 h-10 rounded overflow-hidden flex-shrink-0 bg-black/20">
                                {% if track.album_image_url %}
                                <img src="{{ track.album_image_url }}" alt="" class="w-full h-full object-cover" loading="lazy">
                                {% else %}
                                <div class="w-full h-full flex items-center justify-center text-white/30">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Track Info -->
                            <div class="ml-3 flex-1 min-w-0">
                                <p class="text-white text-sm font-medium truncate">{{ track.name }}</p>
                                <p class="text-white/50 text-xs truncate">{{ track.artists | join(', ') }}</p>
                            </div>

                            <!-- Duration -->
                            <span class="w-24 text-right text-white/50 text-sm hidden sm:block">
                                {{ '%d:%02d' | format(track.duration_ms // 60000, (track.duration_ms % 60000) // 1000) }}
                            </span>

                            <!-- Delete Button -->
                            <button class="delete-track-btn w-8 text-center text-white/20 hover:text-red-400 transition duration-150 ml-1 flex-shrink-0"
                                    onclick="deleteTrack('{{ track.uri }}', this)"
                                    title="Remove from playlist">
                                <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>

                            <!-- Drag Handle -->
                            <span class="drag-handle w-8 text-center text-white/30 hover:text-white/60 cursor-grab active:cursor-grabbing ml-1 flex-shrink-0">
                                <svg class="w-5 h-5 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 6h2v2H8V6zm6 0h2v2h-2V6zM8 11h2v2H8v-2zm6 0h2v2h-2v-2zm-6 5h2v2H8v-2zm6 0h2v2h-2v-2z"/>
                                </svg>
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Source Playlists Panel -->
                <div class="mt-6">
                    <button id="source-panel-toggle"
                            onclick="toggleSourcePanel()"
                            class="w-full flex items-center justify-between px-5 py-3 rounded-2xl shadow-xl backdrop-blur-md bg-white/10 border border-white/20 text-white font-bold text-lg hover:bg-white/15 transition duration-150"
                            aria-expanded="false"
                            aria-controls="source-panel-body">
                        <span class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            Source Playlists
                        </span>
                        <svg id="source-panel-chevron" class="w-5 h-5 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <div id="source-panel-body" class="hidden mt-2 rounded-2xl shadow-xl backdrop-blur-md bg-white/10 border border-white/20 overflow-hidden">
                        <!-- Source Playlist Selector -->
                        <div class="px-5 py-4 border-b border-white/10">
                            <label for="source-playlist-select" class="block text-sm font-medium text-white/90 mb-2">
                                Load tracks from another playlist:
                            </label>
                            <div class="flex items-center space-x-2">
                                <select id="source-playlist-select"
                                        class="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-white/30 focus:border-transparent"
                                        disabled>
                                    <option value="">Loading playlists...</option>
                                </select>
                                <button id="load-source-btn"
                                        onclick="loadSourcePlaylist()"
                                        disabled
                                        class="px-4 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white font-semibold transition duration-150 disabled:opacity-40 disabled:cursor-not-allowed">
                                    Load
                                </button>
                            </div>
                        </div>

                        <!-- Source Track List -->
                        <div id="source-tracks-container" class="hidden">
                            <div class="px-4 py-2 border-b border-white/10 flex items-center justify-between">
                                <div class="flex items-center text-white/60 text-xs uppercase tracking-wide font-semibold">
                                    <span class="w-10"></span>
                                    <span class="ml-3">Source Tracks</span>
                                </div>
                                <span id="source-track-count" class="text-white/50 text-xs">0 tracks</span>
                            </div>
                            <div id="source-track-list" class="max-h-[40vh] overflow-y-auto workshop-scrollbar">
                            </div>
                        </div>

                        <!-- Empty state -->
                        <div id="source-empty-state" class="px-5 py-6 text-center text-white/50 text-sm">
                            Select a playlist above and click "Load" to browse its tracks.
                        </div>

                        <!-- Loading state -->
                        <div id="source-loading-state" class="hidden px-5 py-6 text-center text-white/50 text-sm">
                            <svg class="w-6 h-6 mx-auto mb-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Loading tracks...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Controls (1/3 width on large screens) -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Shuffle Controls Panel -->
                <div class="rounded-2xl shadow-xl backdrop-blur-md bg-white/10 border border-white/20 p-5">
                    <h2 class="text-white font-bold text-lg mb-4">Shuffle Preview</h2>
                    <p class="text-white/60 text-sm mb-4">Preview a shuffle without affecting Spotify. Only saved when you click "Save to Spotify".</p>

                    <!-- Algorithm Selection -->
                    <div class="mb-4">
                        <label for="workshop-algorithm" class="block text-sm font-medium text-white/90 mb-2">
                            Algorithm:
                        </label>
                        <select id="workshop-algorithm"
                                name="algorithm"
                                class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-white/30 focus:border-transparent">
                            {% for algo in algorithms %}
                            <option value="{{ algo.class_name }}"
                                    data-description="{{ algo.description }}"
                                    data-parameters='{{ algo.parameters | tojson }}'>
                                {{ algo.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <p id="algorithm-description" class="mt-1 text-sm text-white/60">
                            {{ algorithms[0].description if algorithms else '' }}
                        </p>
                    </div>

                    <!-- Dynamic Algorithm Parameters -->
                    <div id="workshop-algorithm-params" class="space-y-4 mb-4">
                        <!-- Parameters dynamically inserted here -->
                    </div>

                    <!-- Preview Shuffle Button -->
                    <button id="preview-shuffle-btn"
                            onclick="previewShuffle()"
                            class="w-full px-4 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white font-semibold transition duration-150"
                            {% if not playlist.tracks %}disabled{% endif %}>
                        Preview Shuffle
                    </button>
                </div>

                <!-- External Playlist Panel -->
                <div class="rounded-2xl shadow-xl backdrop-blur-md bg-white/10 border border-white/20 p-5">
                    <h2 class="text-white font-bold text-lg mb-3">Load External Playlist</h2>
                    <p class="text-white/60 text-sm mb-3">Paste a Spotify playlist URL or search by name.</p>

                    <!-- URL/Search Input -->
                    <div class="flex space-x-2 mb-3">
                        <input id="external-playlist-input"
                               type="text"
                               placeholder="Paste URL or search..."
                               class="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white text-sm placeholder-white/40 focus:ring-2 focus:ring-white/30 focus:border-transparent"
                               onkeydown="if(event.key==='Enter') loadExternalPlaylist()">
                        <button onclick="loadExternalPlaylist()"
                                class="px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white text-sm font-semibold transition duration-150 flex-shrink-0">
                            Load
                        </button>
                    </div>

                    <!-- Search Results (hidden by default) -->
                    <div id="external-search-results" class="hidden max-h-48 overflow-y-auto workshop-scrollbar space-y-1">
                    </div>

                    <!-- Recently Loaded (from session) -->
                    {% if session.get('external_playlist_history') %}
                    <div class="mt-3">
                        <p class="text-white/50 text-xs uppercase tracking-wide font-semibold mb-2">Recently Loaded</p>
                        <div id="external-recent-list" class="space-y-1 max-h-32 overflow-y-auto workshop-scrollbar">
                            {% for entry in session.get('external_playlist_history', [])[:5] %}
                            <button onclick="loadExternalById('{{ entry.id }}')"
                                    class="w-full text-left px-2 py-1.5 rounded-lg hover:bg-white/10 transition duration-150 text-sm text-white/80 truncate">
                                {{ entry.name }} <span class="text-white/40">({{ entry.track_count }} tracks)</span>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Loading indicator -->
                    <div id="external-loading" class="hidden py-3 text-center">
                        <svg class="w-6 h-6 mx-auto animate-spin text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <p class="text-white/50 text-xs mt-1">Loading...</p>
                    </div>
                </div>

                <!-- Search Spotify Panel -->
                <div class="rounded-2xl shadow-xl backdrop-blur-md bg-white/10 border border-white/20 p-5">
                    <h2 class="text-white font-bold text-lg mb-3">Search Spotify</h2>
                    <p class="text-white/60 text-sm mb-3">Find tracks to add to your playlist.</p>

                    <!-- Search Input -->
                    <div class="flex items-center space-x-2 mb-4">
                        <input id="search-input"
                               type="text"
                               placeholder="Search tracks, artists..."
                               class="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:ring-2 focus:ring-white/30 focus:border-transparent text-sm"
                               onkeydown="if(event.key==='Enter'){event.preventDefault(); searchSpotify();}"
                               maxlength="200"
                               autocomplete="off">
                        <button id="search-btn"
                                onclick="searchSpotify()"
                                class="px-3 py-2 rounded-lg bg-white/20 hover:bg-white/30 text-white transition duration-150 flex-shrink-0"
                                title="Search">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Search Results Container -->
                    <div id="search-results" class="space-y-1 max-h-[40vh] overflow-y-auto workshop-scrollbar">
                        <p id="search-placeholder" class="text-white/40 text-sm text-center py-4">
                            Type a query and press Enter
                        </p>
                    </div>

                    <!-- Load More Button (hidden by default) -->
                    <button id="search-load-more"
                            onclick="searchSpotifyMore()"
                            class="hidden w-full mt-2 px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-white/70 text-sm transition duration-150">
                        Load more results
                    </button>
                </div>

                <!-- Playlist Info Panel -->
                <div class="rounded-2xl shadow-xl backdrop-blur-md bg-white/10 border border-white/20 p-5">
                    <h2 class="text-white font-bold text-lg mb-3">Playlist Info</h2>
                    <dl class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <dt class="text-white/60">Tracks</dt>
                            <dd class="text-white font-medium" id="info-track-count">{{ playlist.tracks | length }}</dd>
                        </div>
                        {% if playlist.description %}
                        <div>
                            <dt class="text-white/60 mb-1">Description</dt>
                            <dd class="text-white/80 text-xs">{{ playlist.description }}</dd>
                        </div>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- =========================================================================
     Workshop Powertools Sidebar
     A collapsible tabbed panel on the right edge of the viewport.
     Phases 2-5 will populate each tab with real content.
     ========================================================================= -->

<!-- Sidebar Toggle Button (visible when sidebar is collapsed) -->
<button id="sidebar-toggle-btn"
        onclick="workshopSidebar.toggle()"
        class="fixed right-0 top-1/2 -translate-y-1/2 z-30 flex items-center justify-center w-10 h-24 rounded-l-xl bg-white/15 backdrop-blur-md border border-r-0 border-white/20 text-white/70 hover:text-white hover:bg-white/25 transition-all duration-200 shadow-lg"
        title="Open Powertools"
        aria-label="Toggle powertools sidebar"
        aria-expanded="false"
        aria-controls="sidebar-panel">
    <div class="flex flex-col items-center gap-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7"></path>
        </svg>
        <span class="text-xs font-bold tracking-widest" style="writing-mode: vertical-rl; text-orientation: mixed;">TOOLS</span>
    </div>
</button>

<!-- Sidebar Panel -->
<div id="sidebar-panel"
     class="fixed top-0 right-0 h-full z-30 flex transition-transform duration-300 ease-in-out translate-x-full"
     aria-hidden="true">

    <!-- Vertical Tab Bar (left edge of sidebar) -->
    <div class="flex flex-col items-center py-4 w-14 bg-black/30 backdrop-blur-xl border-l border-white/10 flex-shrink-0">
        <!-- Close / collapse button -->
        <button onclick="workshopSidebar.toggle()"
                class="mb-4 p-2 rounded-lg text-white/60 hover:text-white hover:bg-white/10 transition duration-150"
                title="Close sidebar"
                aria-label="Close powertools sidebar">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7"></path>
            </svg>
        </button>

        <div class="w-8 border-t border-white/10 mb-4"></div>

        <!-- Tab: Snapshots -->
        <button class="sidebar-tab-btn mb-2 p-2 rounded-lg transition duration-150 text-white/40 hover:text-white hover:bg-white/10"
                data-tab="snapshots"
                onclick="workshopSidebar.switchTab('snapshots')"
                title="Snapshots"
                aria-label="Snapshots tab"
                aria-selected="false"
                role="tab">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        </button>

        <!-- Tab: Archive -->
        <button class="sidebar-tab-btn mb-2 p-2 rounded-lg transition duration-150 text-white/40 hover:text-white hover:bg-white/10"
                data-tab="archive"
                onclick="workshopSidebar.switchTab('archive')"
                title="Archive"
                aria-label="Archive tab"
                aria-selected="false"
                role="tab">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
            </svg>
        </button>

        <!-- Tab: Raids -->
        <button class="sidebar-tab-btn mb-2 p-2 rounded-lg transition duration-150 text-white/40 hover:text-white hover:bg-white/10"
                data-tab="raids"
                onclick="workshopSidebar.switchTab('raids')"
                title="Raids"
                aria-label="Raids tab"
                aria-selected="false"
                role="tab">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
        </button>

        <!-- Tab: Schedules -->
        <button class="sidebar-tab-btn mb-2 p-2 rounded-lg transition duration-150 text-white/40 hover:text-white hover:bg-white/10"
                data-tab="schedules"
                onclick="workshopSidebar.switchTab('schedules')"
                title="Schedules"
                aria-label="Schedules tab"
                aria-selected="false"
                role="tab">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </button>
    </div>

    <!-- Tab Content Area -->
    <div class="w-80 bg-black/40 backdrop-blur-xl border-l border-white/10 overflow-y-auto sidebar-scrollbar">

        <!-- Tab Content: Snapshots -->
        <div id="sidebar-tab-snapshots" class="sidebar-tab-content hidden p-5" role="tabpanel">
            <!-- Header with Take Snapshot button -->
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-white font-bold text-lg">Snapshots</h3>
                <button id="snapshot-take-btn"
                        onclick="openManualSnapshotDialog()"
                        class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-white/70 hover:text-white text-xs font-semibold transition duration-150 flex items-center gap-1.5"
                        title="Take a snapshot of the current playlist state">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Take Snapshot
                </button>
            </div>

            <!-- Manual Snapshot Form (hidden by default) -->
            <div id="snapshot-create-form" class="hidden mb-3">
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <label class="block text-white/60 text-xs font-semibold mb-1.5">Description (optional)</label>
                    <input id="snapshot-description-input"
                           type="text"
                           maxlength="500"
                           placeholder="e.g. Before major cleanup"
                           class="w-full px-3 py-2 rounded-lg bg-white/10 border border-white/10 text-white text-sm placeholder-white/30 focus:outline-none focus:border-white/30 focus:ring-1 focus:ring-white/20 transition">
                    <div class="flex gap-2 mt-3">
                        <button onclick="confirmManualSnapshot()"
                                class="flex-1 px-3 py-1.5 rounded-lg bg-green-600/80 hover:bg-green-600 text-white text-xs font-semibold transition duration-150">
                            Save Snapshot
                        </button>
                        <button onclick="cancelManualSnapshot()"
                                class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-white/70 text-xs font-semibold transition duration-150">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="snapshot-loading" class="hidden">
                <div class="flex items-center justify-center py-8">
                    <svg class="w-6 h-6 text-white/30 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="ml-2 text-white/40 text-sm">Loading snapshots...</span>
                </div>
            </div>

            <!-- Error State -->
            <div id="snapshot-error" class="hidden">
                <div class="rounded-xl bg-red-500/10 border border-red-500/20 p-4 text-center">
                    <p id="snapshot-error-message" class="text-red-400/80 text-sm mb-2">Failed to load snapshots</p>
                    <button onclick="loadSnapshots()"
                            class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-white/60 text-xs font-semibold transition duration-150">
                        Try Again
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="snapshot-empty" class="hidden">
                <div class="rounded-xl bg-white/5 border border-white/10 p-6 text-center">
                    <svg class="w-10 h-10 mx-auto text-white/15 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <p class="text-white/50 text-sm mb-1">No snapshots yet</p>
                    <p class="text-white/30 text-xs">Snapshots are created automatically before shuffles, raids, and commits. You can also take one manually.</p>
                </div>
            </div>

            <!-- Snapshot Timeline -->
            <div id="snapshot-timeline" class="hidden relative">
                <div id="snapshot-list" class="space-y-2 snapshot-timeline-container"></div>
                <div class="snapshot-timeline-fade pointer-events-none"></div>
            </div>
        </div>

        <!-- Tab Content: Archive -->
        <div id="sidebar-tab-archive" class="sidebar-tab-content hidden p-5" role="tabpanel">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-white font-bold text-lg">Archive</h3>
                <span id="archive-queue-badge" class="hidden px-2 py-0.5 rounded-full bg-yellow-500/80 text-xs font-semibold text-white">0 queued</span>
            </div>

            <!-- Loading state -->
            <div id="archive-loading" class="hidden text-center py-6">
                <svg class="w-8 h-8 mx-auto text-white/30 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <p class="text-white/40 text-sm mt-2">Loading...</p>
            </div>

            <!-- No pair state -->
            <div id="archive-no-pair" class="hidden">
                <div class="rounded-xl bg-white/5 border border-white/10 p-6 text-center">
                    <svg class="w-12 h-12 mx-auto text-white/20 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                    </svg>
                    <p class="text-white/60 text-sm mb-1">No archive linked</p>
                    <p class="text-white/30 text-xs mb-4">Link an archive playlist so removed tracks are automatically preserved.</p>
                    <button onclick="createArchivePair()"
                            class="px-4 py-2 rounded-lg bg-spotify-green/80 hover:bg-spotify-green text-white text-sm font-semibold transition duration-150">
                        Create Archive Pair
                    </button>
                </div>
            </div>

            <!-- Paired state -->
            <div id="archive-paired" class="hidden">
                <!-- Pair info card -->
                <div class="rounded-xl bg-white/5 border border-white/10 p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-white/60 text-xs uppercase tracking-wide font-semibold">Archive Playlist</span>
                        <button onclick="deleteArchivePair()"
                                class="text-red-400/60 hover:text-red-400 text-xs transition duration-150"
                                title="Remove archive pairing">
                            Unlink
                        </button>
                    </div>
                    <p id="archive-pair-name" class="text-white font-medium text-sm truncate"></p>
                    <p id="archive-pair-track-count" class="text-white/40 text-xs mt-1"></p>
                </div>

                <!-- Archive track list -->
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white/60 text-xs uppercase tracking-wide font-semibold">Archived Tracks</span>
                    <button onclick="loadArchiveTracks()"
                            class="text-white/40 hover:text-white/60 transition duration-150"
                            title="Refresh archive tracks">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>

                <div id="archive-track-list" class="space-y-1 max-h-[50vh] overflow-y-auto sidebar-scrollbar">
                    <!-- Populated by renderArchiveTrackList() -->
                </div>

                <div id="archive-tracks-empty" class="hidden rounded-xl bg-white/5 border border-white/10 p-4 text-center">
                    <p class="text-white/40 text-sm">No archived tracks yet</p>
                    <p class="text-white/20 text-xs mt-1">Tracks removed from this playlist will appear here after saving.</p>
                </div>
            </div>

            <!-- Error state -->
            <div id="archive-error" class="hidden rounded-xl bg-red-500/10 border border-red-500/20 p-4 text-center">
                <p class="text-red-300 text-sm">Failed to load archive info</p>
                <button onclick="loadArchivePairInfo()"
                        class="text-red-300/60 hover:text-red-300 text-xs mt-2 underline transition duration-150">
                    Retry
                </button>
            </div>
        </div>

        <!-- Tab Content: Raids -->
        <div id="sidebar-tab-raids" class="sidebar-tab-content hidden p-5" role="tabpanel">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-white font-bold text-lg">Raids</h3>
                <button onclick="raidPanel.loadStatus()"
                        class="text-white/40 hover:text-white/60 transition duration-150"
                        title="Refresh raid status">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>

            <!-- Loading state -->
            <div id="raid-loading" class="hidden text-center py-6">
                <svg class="w-8 h-8 mx-auto text-white/30 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <p class="text-white/40 text-sm mt-2">Loading raid status...</p>
            </div>

            <!-- Raid panel content -->
            <div id="raid-panel-content" class="hidden space-y-4">

                <!-- Quick Watch Section -->
                <div class="rounded-xl bg-white/5 border border-white/10 p-4">
                    <label class="text-white/60 text-xs uppercase tracking-wide font-semibold block mb-2">Watch a playlist</label>
                    <select id="raid-playlist-select"
                            class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-spotify-green/50 mb-2">
                        <option value="">Select a playlist...</option>
                    </select>
                    <button id="raid-watch-btn" onclick="raidPanel.watchPlaylist()"
                            class="w-full px-4 py-2 rounded-lg bg-spotify-green/80 hover:bg-spotify-green text-white text-sm font-semibold transition duration-150 disabled:opacity-40 disabled:cursor-not-allowed"
                            disabled>
                        Watch Playlist
                    </button>
                    <p class="text-white/30 text-xs mt-2">Watched playlists are checked for new tracks on a schedule.</p>
                </div>

                <!-- Watched Sources List -->
                <div>
                    <span class="text-white/60 text-xs uppercase tracking-wide font-semibold block mb-2">Watched Sources</span>
                    <div id="raid-sources-list" class="space-y-1 max-h-[30vh] overflow-y-auto sidebar-scrollbar">
                        <!-- Populated by raidPanel.renderSources() -->
                    </div>
                    <div id="raid-sources-empty" class="hidden rounded-xl bg-white/5 border border-white/10 p-4 text-center">
                        <p class="text-white/40 text-sm">No sources watched</p>
                        <p class="text-white/20 text-xs mt-1">Select a playlist above to start watching.</p>
                    </div>
                </div>

                <!-- Schedule Status -->
                <div id="raid-schedule-section">
                    <span class="text-white/60 text-xs uppercase tracking-wide font-semibold block mb-2">Schedule</span>
                    <div id="raid-schedule-info" class="hidden rounded-xl bg-white/5 border border-white/10 p-3">
                        <div class="flex items-center justify-between mb-1">
                            <span id="raid-schedule-interval" class="text-white text-sm font-medium"></span>
                            <button onclick="raidPanel.toggleSchedule()" id="raid-schedule-toggle"
                                    class="px-2 py-0.5 rounded-full text-xs font-semibold transition duration-150">
                            </button>
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                            <span id="raid-schedule-last-run" class="text-white/40"></span>
                            <span id="raid-schedule-status-badge" class="px-1.5 py-0.5 rounded-full text-xs font-semibold"></span>
                        </div>
                    </div>
                    <div id="raid-no-schedule" class="hidden text-white/30 text-xs">
                        No schedule configured. Watch a playlist to auto-create one.
                    </div>
                </div>

                <!-- Raid Now -->
                <button id="raid-now-btn" onclick="raidPanel.raidNow()"
                        class="w-full inline-flex items-center justify-center px-4 py-2.5 rounded-lg bg-white/10 hover:bg-white/20 text-white font-semibold text-sm transition duration-150 border border-white/20 disabled:opacity-40 disabled:cursor-not-allowed">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Raid Now
                </button>
            </div>

            <!-- Error state -->
            <div id="raid-error" class="hidden rounded-xl bg-red-500/10 border border-red-500/20 p-4 text-center">
                <p class="text-red-300 text-sm">Failed to load raid status</p>
                <button onclick="raidPanel.loadStatus()"
                        class="text-red-300/60 hover:text-red-300 text-xs mt-2 underline transition duration-150">
                    Retry
                </button>
            </div>
        </div>

        <!-- Tab Content: Schedules (Rotation Panel) -->
        <div id="sidebar-tab-schedules" class="sidebar-tab-content hidden p-5" role="tabpanel">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-white font-bold text-lg">Rotation</h3>
                <button onclick="loadRotationStatus()" class="text-white/40 hover:text-white/70 text-xs transition" title="Refresh">
                    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>

            <div id="rotation-panel-content">
                <!-- Loading state -->
                <div class="text-center py-6">
                    <div class="inline-block w-6 h-6 border-2 border-white/20 border-t-white/60 rounded-full animate-spin"></div>
                    <p class="text-white/40 text-xs mt-2">Loading rotation status...</p>
                </div>
            </div>

            <!-- Manage All Schedules link -->
            <div class="mt-4 pt-3 border-t border-white/10">
                <a href="/schedules" class="text-spotify-green hover:text-green-400 text-sm font-medium transition inline-flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Manage All Schedules
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar Backdrop (mobile overlay) -->
<div id="sidebar-backdrop"
     class="fixed inset-0 z-20 bg-black/50 backdrop-blur-sm hidden transition-opacity duration-300 opacity-0 lg:hidden"
     onclick="workshopSidebar.close()">
</div>

<!-- Snapshot Restore Confirmation Modal -->
<div id="snapshot-restore-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="hideRestoreModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm">
        <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 shadow-2xl">
            <h3 class="text-white font-bold text-lg mb-2">Restore Snapshot</h3>
            <p id="restore-modal-message" class="text-white/60 text-sm mb-1">This will replace the current playlist track order on Spotify.</p>
            <p id="restore-modal-detail" class="text-white/40 text-xs mb-4"></p>
            <div class="flex gap-3">
                <button onclick="executeRestore()"
                        class="flex-1 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold transition duration-150">
                    Restore
                </button>
                <button onclick="hideRestoreModal()"
                        class="flex-1 px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white/70 text-sm font-semibold transition duration-150">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Snapshot Delete Confirmation Modal -->
<div id="snapshot-delete-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="hideDeleteModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm">
        <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 shadow-2xl">
            <h3 class="text-white font-bold text-lg mb-2">Delete Snapshot</h3>
            <p id="delete-modal-message" class="text-white/60 text-sm mb-4">This snapshot will be permanently deleted. This cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="executeDelete()"
                        class="flex-1 px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-semibold transition duration-150">
                    Delete
                </button>
                <button onclick="hideDeleteModal()"
                        class="flex-1 px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white/70 text-sm font-semibold transition duration-150">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SortableJS via CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>

<script>
// =============================================================================
// Workshop State Management
// =============================================================================

const workshopState = {
    playlistId: {{ playlist.id | tojson }},
    playlistName: {{ playlist.name | tojson }},
    currentUserId: {{ user.id | tojson }},
    savedUris: {{ playlist.tracks | map(attribute='uri') | list | tojson }},
    workingUris: {{ playlist.tracks | map(attribute='uri') | list | tojson }},
    isDirty: false,
    isSaving: false,
    isShuffling: false,
    // Source panel state
    sourcePlaylistId: null,
    sourcePlaylistName: null,
    sourceTracks: [],
    playlistsLoaded: false,
    isLoadingSource: false,
    // Archive pairing state
    archiveQueue: [],
    archivePair: null,
    archiveTracks: [],
};

const trackDataByUri = {};
{% for track in playlist.tracks %}
trackDataByUri[{{ track.uri | tojson }}] = {
    id: {{ track.id | tojson }},
    name: {{ track.name | tojson }},
    artists: {{ track.artists | tojson }},
    album_name: {{ (track.album_name or '') | tojson }},
    album_image_url: {{ (track.album_image_url or '') | tojson }},
    duration_ms: {{ track.duration_ms | tojson }},
    uri: {{ track.uri | tojson }},
};
{% endfor %}


// =============================================================================
// SortableJS Initialization
// =============================================================================

let sortableInstance = null;

document.addEventListener('DOMContentLoaded', () => {
    const trackList = document.getElementById('track-list');
    if (!trackList || trackList.children.length === 0) return;

    sortableInstance = Sortable.create(trackList, {
        animation: 200,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        group: {
            name: 'workshop-tracks',
            pull: true,
            put: true,
        },
        onAdd: function(evt) {
            handleSourceTrackAddedViaDrag(evt);
        },
        onEnd: function(evt) {
            updateWorkingUrisFromDOM();
            markDirty();
        },
    });

    updateWorkshopAlgorithmParams();
    document.getElementById('workshop-algorithm').addEventListener('change', updateWorkshopAlgorithmParams);
});


// =============================================================================
// DOM / State Sync
// =============================================================================

function updateWorkingUrisFromDOM() {
    const items = document.querySelectorAll('#track-list .track-item');
    workshopState.workingUris = Array.from(items).map(el => el.dataset.uri);
    renumberTracks();
}

function renumberTracks() {
    const items = document.querySelectorAll('#track-list .track-item .track-number');
    items.forEach((el, i) => { el.textContent = i + 1; });
}

function markDirty() {
    const changed = !arraysEqual(workshopState.savedUris, workshopState.workingUris);
    workshopState.isDirty = changed;

    const saveBtn = document.getElementById('save-btn');
    const undoBtn = document.getElementById('undo-preview-btn');
    const badge = document.getElementById('modified-badge');

    saveBtn.disabled = !changed || workshopState.isSaving;
    undoBtn.classList.toggle('hidden', !changed);
    badge.classList.toggle('hidden', !changed);
}

function arraysEqual(a, b) {
    if (a.length !== b.length) return false;
    for (let i = 0; i < a.length; i++) {
        if (a[i] !== b[i]) return false;
    }
    return true;
}


// =============================================================================
// Shuffle Preview
// =============================================================================

function previewShuffle() {
    if (workshopState.isShuffling) return;

    const select = document.getElementById('workshop-algorithm');
    const algorithmName = select.value;

    const paramsContainer = document.getElementById('workshop-algorithm-params');
    const paramInputs = paramsContainer.querySelectorAll('input, select');

    // Send full track objects so the server can shuffle without an API call
    const tracks = workshopState.workingUris.map(uri => trackDataByUri[uri]);
    const body = {
        algorithm: algorithmName,
        tracks: tracks,
    };
    paramInputs.forEach(input => {
        body[input.name] = input.value;
    });

    const btn = document.getElementById('preview-shuffle-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Shuffling...';
    workshopState.isShuffling = true;

    fetch(`/workshop/${workshopState.playlistId}/preview-shuffle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify(body),
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => { throw new Error(data.message || 'Shuffle preview failed.'); });
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.shuffled_uris) {
            workshopState.workingUris = data.shuffled_uris;
            rerenderTrackList();
            markDirty();
            showNotification(`Preview applied: ${data.algorithm_name}`, 'success');
        } else {
            showNotification(data.message || 'Shuffle did not change order.', 'info');
        }
    })
    .catch(error => {
        console.error('Preview shuffle error:', error);
        showNotification(error.message || 'Failed to preview shuffle.', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = originalText;
        workshopState.isShuffling = false;
    });
}


// =============================================================================
// Commit to Spotify
// =============================================================================

function commitToSpotify() {
    if (workshopState.isSaving || !workshopState.isDirty) return;

    const btn = document.getElementById('save-btn');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `
        <svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Saving...
    `;
    workshopState.isSaving = true;

    fetch(`/workshop/${workshopState.playlistId}/commit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({ track_uris: workshopState.workingUris }),
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => { throw new Error(data.message || 'Save failed.'); });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            workshopState.savedUris = [...workshopState.workingUris];
            markDirty();
            refreshSourceDuplicateIndicators();
            showNotification(data.message || 'Saved to Spotify!', 'success');
            // Refresh snapshot list to show new auto-snapshot
            if (typeof snapshotState !== 'undefined' && snapshotState.isLoaded) {
                setTimeout(function() { loadSnapshots(); }, 500);
            }
            // Flush archive queue (best-effort, after commit succeeds)
            if (workshopState.archiveQueue.length > 0) {
                flushArchiveQueue();
            }
        } else {
            showNotification(data.message || 'Save returned unexpected response.', 'error');
        }
    })
    .catch(error => {
        console.error('Commit error:', error);
        showNotification(error.message || 'Failed to save to Spotify. Please try again.', 'error');
    })
    .finally(() => {
        btn.disabled = !workshopState.isDirty;
        btn.innerHTML = originalHTML;
        workshopState.isSaving = false;
    });
}


// =============================================================================
// Undo Preview (revert to last saved order)
// =============================================================================

function undoPreview() {
    workshopState.workingUris = [...workshopState.savedUris];
    workshopState.archiveQueue = [];
    updateArchiveQueueBadge();
    fullRerenderTrackList();
    updateTrackCount();
    markDirty();
    refreshSourceDuplicateIndicators();
    showNotification('Reverted to last saved order.', 'success');
}


// =============================================================================
// Track List Rendering (after shuffle preview reorders URIs)
// =============================================================================

function rerenderTrackList() {
    fullRerenderTrackList();
}


// =============================================================================
// Algorithm Parameter UI (mirrors dashboard.html pattern)
// =============================================================================

function updateWorkshopAlgorithmParams() {
    const select = document.getElementById('workshop-algorithm');
    const paramsContainer = document.getElementById('workshop-algorithm-params');
    const selectedOption = select.options[select.selectedIndex];
    const parameters = JSON.parse(selectedOption.dataset.parameters);
    const description = selectedOption.dataset.description;

    document.getElementById('algorithm-description').textContent = description;
    paramsContainer.innerHTML = '';

    for (const [paramName, paramInfo] of Object.entries(parameters)) {
        const paramDiv = document.createElement('div');
        paramDiv.className = 'space-y-1';

        const label = document.createElement('label');
        label.className = 'block text-sm font-medium text-white/90';
        label.textContent = paramInfo.description;
        paramDiv.appendChild(label);

        if (paramInfo.type === 'string' && paramInfo.options) {
            const sel = document.createElement('select');
            sel.name = paramName;
            sel.className = 'w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-white/30 focus:border-transparent';
            for (const option of paramInfo.options) {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                if (option === paramInfo.default) opt.selected = true;
                sel.appendChild(opt);
            }
            paramDiv.appendChild(sel);
        } else {
            const input = document.createElement('input');
            input.type = paramInfo.type === 'float' ? 'number' :
                         paramInfo.type === 'integer' ? 'number' : 'text';
            input.name = paramName;
            input.className = 'w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-white/30 focus:border-transparent';
            input.value = paramInfo.default;
            if (paramInfo.min !== undefined) input.min = paramInfo.min;
            if (paramInfo.max !== undefined) input.max = paramInfo.max;
            if (paramInfo.type === 'float') input.step = '0.1';
            paramDiv.appendChild(input);
        }

        paramsContainer.appendChild(paramDiv);
    }
}


// =============================================================================
// Notifications
// =============================================================================

function showNotification(message, type) {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500/90' :
                    type === 'info' ? 'bg-blue-500/90' : 'bg-red-500/90';
    notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg backdrop-blur-md ${bgColor} text-white font-semibold transform transition duration-300 translate-y-16 opacity-0 z-50`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.remove('translate-y-16', 'opacity-0');
    }, 100);

    setTimeout(() => {
        notification.classList.add('translate-y-16', 'opacity-0');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}


// =============================================================================
// Delete Track
// =============================================================================

function deleteTrack(uri, buttonElement) {
    const trackItem = buttonElement.closest('.track-item');
    if (!trackItem) return;

    // Get the index from DOM position (handles duplicates correctly)
    const allItems = Array.from(document.querySelectorAll('#track-list .track-item'));
    const domIndex = allItems.indexOf(trackItem);
    if (domIndex === -1) return;

    // Remove from workingUris at the same index
    workshopState.workingUris.splice(domIndex, 1);

    // Queue for archiving if pair exists with auto-archive enabled
    if (workshopState.archivePair && workshopState.archivePair.auto_archive_on_remove) {
        workshopState.archiveQueue.push(uri);
        updateArchiveQueueBadge();
    }

    // Remove the DOM element with a fade-out animation
    trackItem.style.transition = 'opacity 0.2s ease-out, max-height 0.3s ease-out';
    trackItem.style.opacity = '0';
    trackItem.style.maxHeight = trackItem.offsetHeight + 'px';
    trackItem.style.overflow = 'hidden';

    setTimeout(() => {
        trackItem.style.maxHeight = '0';
        trackItem.style.padding = '0';
        setTimeout(() => {
            trackItem.remove();
            renumberTracks();
            updateTrackCount();
            markDirty();
        }, 300);
    }, 200);

    showNotification('Track removed from working copy.', 'info');
}


// =============================================================================
// Track Count Update
// =============================================================================

function updateTrackCount() {
    const count = workshopState.workingUris.length;
    const countEl = document.getElementById('track-count');
    const infoCountEl = document.getElementById('info-track-count');
    if (countEl) countEl.textContent = count;
    if (infoCountEl) infoCountEl.textContent = count;
}


// =============================================================================
// Full Re-render (handles additions and deletions, not just reordering)
// =============================================================================

function fullRerenderTrackList() {
    const container = document.getElementById('track-list');
    const existingElements = {};
    container.querySelectorAll('.track-item').forEach(el => {
        const uri = el.dataset.uri;
        if (!existingElements[uri]) existingElements[uri] = [];
        existingElements[uri].push(el);
    });

    const usedElements = new Set();

    workshopState.workingUris.forEach((uri, index) => {
        const available = existingElements[uri];
        let el = null;

        if (available && available.length > 0) {
            el = available.shift();
            usedElements.add(el);
            container.appendChild(el);
        } else if (trackDataByUri[uri]) {
            el = createTrackElement(trackDataByUri[uri], index + 1);
            container.appendChild(el);
        }
    });

    // Remove DOM elements that are no longer in workingUris
    container.querySelectorAll('.track-item').forEach(el => {
        if (!usedElements.has(el) && !workshopState.workingUris.includes(el.dataset.uri)) {
            el.remove();
        }
    });

    renumberTracks();
}


// =============================================================================
// Search Spotify
// =============================================================================

let searchState = {
    currentQuery: '',
    currentOffset: 0,
    isSearching: false,
    limit: 10,
};


function searchSpotify() {
    const input = document.getElementById('search-input');
    const query = input.value.trim();
    if (!query) return;

    searchState.currentQuery = query;
    searchState.currentOffset = 0;

    const container = document.getElementById('search-results');
    container.innerHTML = '';

    executeSearch(query, 0, false);
}


function searchSpotifyMore() {
    if (searchState.isSearching || !searchState.currentQuery) return;
    executeSearch(
        searchState.currentQuery,
        searchState.currentOffset,
        true
    );
}


function executeSearch(query, offset, append) {
    if (searchState.isSearching) return;
    searchState.isSearching = true;

    const searchBtn = document.getElementById('search-btn');
    const loadMoreBtn = document.getElementById('search-load-more');
    searchBtn.disabled = true;

    const container = document.getElementById('search-results');
    if (!append) {
        container.innerHTML = '<p class="text-white/40 text-sm text-center py-4">Searching...</p>';
    } else {
        loadMoreBtn.textContent = 'Loading...';
        loadMoreBtn.disabled = true;
    }

    fetch('/workshop/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({
            query: query,
            limit: searchState.limit,
            offset: offset,
        }),
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => { throw new Error(data.message || 'Search failed.'); });
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Search returned an error.');
        }

        if (!append) {
            container.innerHTML = '';
        }

        if (data.tracks.length === 0 && offset === 0) {
            container.innerHTML = '<p class="text-white/40 text-sm text-center py-4">No results found.</p>';
            loadMoreBtn.classList.add('hidden');
            return;
        }

        data.tracks.forEach(track => {
            container.appendChild(createSearchResultElement(track));
        });

        searchState.currentOffset = offset + data.tracks.length;

        if (data.tracks.length >= searchState.limit) {
            loadMoreBtn.classList.remove('hidden');
        } else {
            loadMoreBtn.classList.add('hidden');
        }
    })
    .catch(error => {
        console.error('Search error:', error);
        if (!append) {
            container.innerHTML = '<p class="text-red-400 text-sm text-center py-4">' + escapeHtml(error.message) + '</p>';
        } else {
            showNotification(error.message || 'Failed to load more results.', 'error');
        }
        loadMoreBtn.classList.add('hidden');
    })
    .finally(() => {
        searchState.isSearching = false;
        searchBtn.disabled = false;
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = 'Load more results';
    });
}


function createSearchResultElement(track) {
    const el = document.createElement('div');
    el.className = 'flex items-center p-2 rounded-lg hover:bg-white/5 transition duration-150 group';
    el.dataset.uri = track.uri;

    const alreadyAdded = workshopState.workingUris.includes(track.uri);

    const albumImg = track.album_image_url
        ? '<img src="' + escapeHtml(track.album_image_url) + '" alt="" class="w-8 h-8 rounded object-cover" loading="lazy">'
        : '<div class="w-8 h-8 rounded bg-black/20 flex items-center justify-center text-white/30"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>';

    const artists = Array.isArray(track.artists) ? track.artists.join(', ') : '';
    const durationMin = Math.floor((track.duration_ms || 0) / 60000);
    const durationSec = Math.floor(((track.duration_ms || 0) % 60000) / 1000);
    const durationStr = durationMin + ':' + String(durationSec).padStart(2, '0');

    el.innerHTML = albumImg +
        '<div class="ml-2 flex-1 min-w-0">' +
            '<p class="text-white text-xs font-medium truncate">' + escapeHtml(track.name) + '</p>' +
            '<p class="text-white/40 text-xs truncate">' + escapeHtml(artists) + '</p>' +
        '</div>' +
        '<span class="text-white/30 text-xs mr-2 hidden sm:inline">' + durationStr + '</span>';

    // Create add button with data attribute instead of inline JSON
    const addBtn = document.createElement('button');
    addBtn.className = 'add-track-btn flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center transition duration-150 ' +
        (alreadyAdded ? 'bg-white/10 text-white/30 cursor-default' : 'bg-white/20 hover:bg-green-500/50 text-white/60 hover:text-white');
    addBtn.title = alreadyAdded ? 'Already in playlist' : 'Add to playlist';
    addBtn.disabled = alreadyAdded;
    addBtn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="' +
        (alreadyAdded ? 'M5 13l4 4L19 7' : 'M12 6v12M6 12h12') + '"></path></svg>';

    // Store track data on the button element to avoid inline JSON in onclick
    addBtn._trackData = track;
    addBtn.addEventListener('click', function() {
        addTrackFromSearch(this, this._trackData);
    });

    el.appendChild(addBtn);
    return el;
}


function escapeHtml(text) {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}


// =============================================================================
// Add Track from Search Results
// =============================================================================

function addTrackFromSearch(button, track) {
    if (!track || !track.uri) return;

    // Add track data to the lookup map
    trackDataByUri[track.uri] = {
        id: track.id,
        name: track.name,
        artists: track.artists || [],
        album_name: track.album_name || '',
        album_image_url: track.album_image_url || '',
        duration_ms: track.duration_ms || 0,
        uri: track.uri,
    };

    // Add URI to the end of the working list
    workshopState.workingUris.push(track.uri);

    // Create and append a new track DOM element
    const trackList = document.getElementById('track-list');
    const newTrackEl = createTrackElement(track, workshopState.workingUris.length);
    trackList.appendChild(newTrackEl);

    // Update button state to show "already added"
    button.disabled = true;
    button.classList.remove('hover:bg-green-500/50', 'text-white/60', 'hover:text-white', 'bg-white/20');
    button.classList.add('bg-white/10', 'text-white/30', 'cursor-default');
    button.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>';
    button.title = 'Already in playlist';

    updateTrackCount();
    markDirty();
    showNotification('Added "' + track.name + '" to playlist.', 'success');

    // Scroll track list to bottom to show new track
    trackList.scrollTop = trackList.scrollHeight;
}


function createTrackElement(track, position) {
    const el = document.createElement('div');
    el.className = 'track-item flex items-center px-4 py-2 hover:bg-white/5 transition duration-150 border-b border-white/5 cursor-grab active:cursor-grabbing';
    el.dataset.uri = track.uri;
    el.dataset.trackId = track.id;

    const artists = Array.isArray(track.artists) ? track.artists.join(', ') : '';
    const durationMin = Math.floor((track.duration_ms || 0) / 60000);
    const durationSec = Math.floor(((track.duration_ms || 0) % 60000) / 1000);
    const durationStr = durationMin + ':' + String(durationSec).padStart(2, '0');

    const albumImg = track.album_image_url
        ? '<img src="' + escapeHtml(track.album_image_url) + '" alt="" class="w-full h-full object-cover" loading="lazy">'
        : '<div class="w-full h-full flex items-center justify-center text-white/30"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>';

    el.innerHTML =
        '<span class="track-number w-10 text-center text-white/50 text-sm font-mono">' + position + '</span>' +
        '<div class="w-10 h-10 rounded overflow-hidden flex-shrink-0 bg-black/20">' + albumImg + '</div>' +
        '<div class="ml-3 flex-1 min-w-0">' +
            '<p class="text-white text-sm font-medium truncate">' + escapeHtml(track.name) + '</p>' +
            '<p class="text-white/50 text-xs truncate">' + escapeHtml(artists) + '</p>' +
        '</div>' +
        '<span class="w-24 text-right text-white/50 text-sm hidden sm:block">' + durationStr + '</span>' +
        '<button class="delete-track-btn w-8 text-center text-white/20 hover:text-red-400 transition duration-150 ml-1 flex-shrink-0" onclick="deleteTrack(\'' + track.uri + '\', this)" title="Remove from playlist">' +
            '<svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
        '</button>' +
        '<span class="drag-handle w-8 text-center text-white/30 hover:text-white/60 cursor-grab active:cursor-grabbing ml-1 flex-shrink-0">' +
            '<svg class="w-5 h-5 mx-auto" fill="currentColor" viewBox="0 0 24 24"><path d="M8 6h2v2H8V6zm6 0h2v2h-2V6zM8 11h2v2H8v-2zm6 0h2v2h-2v-2zm-6 5h2v2H8v-2zm6 0h2v2h-2v-2z"/></svg>' +
        '</span>';

    return el;
}


// =============================================================================
// Source Panel  Toggle, Load, Render
// =============================================================================

let sourceSortableInstance = null;

function toggleSourcePanel() {
    const body = document.getElementById('source-panel-body');
    const chevron = document.getElementById('source-panel-chevron');
    const toggle = document.getElementById('source-panel-toggle');
    const isHidden = body.classList.contains('hidden');

    body.classList.toggle('hidden');
    chevron.classList.toggle('rotate-180');
    toggle.setAttribute('aria-expanded', String(isHidden));

    // Lazy-load playlists on first open
    if (isHidden && !workshopState.playlistsLoaded) {
        fetchUserPlaylists();
    }
}

function fetchUserPlaylists() {
    const select = document.getElementById('source-playlist-select');
    select.disabled = true;
    select.innerHTML = '<option value="">Loading playlists...</option>';

    fetch('/api/user-playlists', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to load playlists.');
            });
        }
        return response.json();
    })
    .then(data => {
        if (!data.success || !data.playlists) {
            throw new Error('Unexpected response format.');
        }

        select.innerHTML = '<option value="">-- Select a playlist --</option>';

        data.playlists.forEach(p => {
            if (p.id === workshopState.playlistId) return;

            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.name + ' (' + p.track_count + ' tracks)';
            option.dataset.name = p.name;
            select.appendChild(option);
        });

        select.disabled = false;
        document.getElementById('load-source-btn').disabled = false;
        workshopState.playlistsLoaded = true;
    })
    .catch(error => {
        console.error('Error fetching playlists:', error);
        select.innerHTML = '<option value="">Failed to load playlists</option>';
        showNotification(error.message || 'Failed to load playlists.', 'error');
    });
}

function loadSourcePlaylist() {
    const select = document.getElementById('source-playlist-select');
    const playlistId = select.value;

    if (!playlistId) {
        showNotification('Please select a playlist first.', 'info');
        return;
    }

    if (workshopState.isLoadingSource) return;

    const selectedOption = select.options[select.selectedIndex];
    const playlistName = selectedOption.dataset.name || selectedOption.textContent;

    workshopState.isLoadingSource = true;
    workshopState.sourcePlaylistId = playlistId;
    workshopState.sourcePlaylistName = playlistName;

    document.getElementById('source-empty-state').classList.add('hidden');
    document.getElementById('source-tracks-container').classList.add('hidden');
    document.getElementById('source-loading-state').classList.remove('hidden');

    const loadBtn = document.getElementById('load-source-btn');
    loadBtn.disabled = true;
    loadBtn.textContent = 'Loading...';

    fetch('/playlist/' + playlistId, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to load playlist.');
            });
        }
        return response.json();
    })
    .then(data => {
        workshopState.sourceTracks = data.tracks || [];
        renderSourceTracks();
    })
    .catch(error => {
        console.error('Error loading source playlist:', error);
        showNotification(error.message || 'Failed to load source playlist.', 'error');
        document.getElementById('source-loading-state').classList.add('hidden');
        document.getElementById('source-empty-state').classList.remove('hidden');
    })
    .finally(() => {
        workshopState.isLoadingSource = false;
        loadBtn.disabled = false;
        loadBtn.textContent = 'Load';
    });
}

function renderSourceTracks() {
    const container = document.getElementById('source-track-list');
    const tracks = workshopState.sourceTracks;

    container.innerHTML = '';

    if (tracks.length === 0) {
        document.getElementById('source-loading-state').classList.add('hidden');
        document.getElementById('source-tracks-container').classList.add('hidden');
        document.getElementById('source-empty-state').classList.remove('hidden');
        document.getElementById('source-empty-state').textContent =
            'This playlist has no tracks.';
        return;
    }

    tracks.forEach(function(track) {
        const isDuplicate = workshopState.workingUris.includes(track.uri);

        const div = document.createElement('div');
        div.className = 'source-track-item flex items-center px-4 py-2 hover:bg-white/5 transition duration-150 border-b border-white/5 cursor-grab active:cursor-grabbing';
        div.dataset.uri = track.uri;
        div.dataset.trackId = track.id;

        const durationMin = Math.floor(track.duration_ms / 60000);
        const durationSec = Math.floor((track.duration_ms % 60000) / 1000);
        const durationStr = durationMin + ':' + String(durationSec).padStart(2, '0');

        const artistsStr = Array.isArray(track.artists) ? track.artists.join(', ') : '';

        const albumImg = track.album_image_url
            ? '<img src="' + escapeHtml(track.album_image_url) + '" alt="" class="w-full h-full object-cover" loading="lazy">'
            : '<div class="w-full h-full flex items-center justify-center text-white/30"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>';

        div.innerHTML =
            '<div class="w-10 h-10 rounded overflow-hidden flex-shrink-0 bg-black/20">' + albumImg + '</div>' +
            '<div class="ml-3 flex-1 min-w-0">' +
                '<p class="text-white text-sm font-medium truncate">' + escapeHtml(track.name) + '</p>' +
                '<p class="text-white/50 text-xs truncate">' + escapeHtml(artistsStr) + '</p>' +
            '</div>' +
            '<span class="w-20 text-right text-white/50 text-sm hidden sm:block">' + durationStr + '</span>';

        // Create add button with data attribute for safe event handling
        const addBtn = document.createElement('button');
        addBtn.className = 'add-source-track-btn ml-2 w-8 h-8 flex items-center justify-center rounded-full transition duration-150 flex-shrink-0 ' +
            (isDuplicate ? 'bg-yellow-500/30 text-yellow-300' : 'bg-white/10 hover:bg-white/20 text-white/70 hover:text-white');
        addBtn.title = isDuplicate ? 'Already in playlist (click to add duplicate)' : 'Add to playlist';
        addBtn.innerHTML = isDuplicate
            ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>';
        addBtn._trackUri = track.uri;
        addBtn.addEventListener('click', function() {
            addSourceTrackToWorking(this._trackUri);
        });

        div.appendChild(addBtn);
        container.appendChild(div);
    });

    document.getElementById('source-track-count').textContent = tracks.length + ' tracks';

    document.getElementById('source-loading-state').classList.add('hidden');
    document.getElementById('source-empty-state').classList.add('hidden');
    document.getElementById('source-tracks-container').classList.remove('hidden');

    initSourceSortable();
}

function initSourceSortable() {
    const sourceList = document.getElementById('source-track-list');
    if (!sourceList) return;

    if (sourceSortableInstance) {
        sourceSortableInstance.destroy();
    }

    sourceSortableInstance = Sortable.create(sourceList, {
        animation: 200,
        sort: false,
        group: {
            name: 'workshop-tracks',
            pull: 'clone',
            put: false,
        },
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
    });
}


// =============================================================================
// Adding Source Tracks to Working Playlist
// =============================================================================

function addSourceTrackToWorking(uri) {
    const isDuplicate = workshopState.workingUris.includes(uri);

    if (isDuplicate) {
        if (!confirm('This track is already in the playlist. Add it again?')) {
            return;
        }
    }

    const trackData = workshopState.sourceTracks.find(function(t) { return t.uri === uri; });
    if (!trackData) {
        showNotification('Track data not found.', 'error');
        return;
    }

    // Register in trackDataByUri if not already there
    if (!trackDataByUri[uri]) {
        trackDataByUri[uri] = {
            id: trackData.id,
            name: trackData.name,
            artists: trackData.artists,
            album_name: trackData.album_name || '',
            album_image_url: trackData.album_image_url || '',
            duration_ms: trackData.duration_ms,
            uri: trackData.uri,
        };
    }

    workshopState.workingUris.push(uri);

    const trackList = document.getElementById('track-list');
    const newEl = createTrackElement(trackData, workshopState.workingUris.length);
    trackList.appendChild(newEl);

    renumberTracks();
    markDirty();
    updateTrackCount();
    refreshSourceDuplicateIndicators();

    showNotification('Added "' + trackData.name + '" to playlist.', 'success');

    trackList.scrollTop = trackList.scrollHeight;
}

function handleSourceTrackAddedViaDrag(evt) {
    const addedEl = evt.item;
    const uri = addedEl.dataset.uri;

    const trackData = workshopState.sourceTracks.find(function(t) { return t.uri === uri; });
    if (!trackData) {
        addedEl.remove();
        return;
    }

    if (!trackDataByUri[uri]) {
        trackDataByUri[uri] = {
            id: trackData.id,
            name: trackData.name,
            artists: trackData.artists,
            album_name: trackData.album_name || '',
            album_image_url: trackData.album_image_url || '',
            duration_ms: trackData.duration_ms,
            uri: trackData.uri,
        };
    }

    const isDuplicate = workshopState.workingUris.includes(uri);
    if (isDuplicate) {
        showNotification('Note: "' + trackData.name + '" is already in the playlist (duplicate added).', 'info');
    }

    // Replace the cloned source element with a proper track-item element
    const newEl = createTrackElement(trackData, workshopState.workingUris.length + 1);
    addedEl.replaceWith(newEl);

    updateWorkingUrisFromDOM();
    markDirty();
    updateTrackCount();
    refreshSourceDuplicateIndicators();
}


// =============================================================================
// Refresh Duplicate Indicators on Source Tracks
// =============================================================================

function refreshSourceDuplicateIndicators() {
    const sourceItems = document.querySelectorAll('#source-track-list .source-track-item');
    sourceItems.forEach(function(item) {
        const uri = item.dataset.uri;
        const isDuplicate = workshopState.workingUris.includes(uri);
        const btn = item.querySelector('.add-source-track-btn');
        if (!btn) return;

        if (isDuplicate) {
            btn.className = 'add-source-track-btn ml-2 w-8 h-8 flex items-center justify-center rounded-full bg-yellow-500/30 text-yellow-300 transition duration-150 flex-shrink-0';
            btn.title = 'Already in playlist (click to add duplicate)';
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        } else {
            btn.className = 'add-source-track-btn ml-2 w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-white/70 hover:text-white transition duration-150 flex-shrink-0';
            btn.title = 'Add to playlist';
            btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>';
        }
    });
}


// =============================================================================
// External Playlist Loading (Phase 4)
// =============================================================================

function loadExternalPlaylist() {
    const input = document.getElementById('external-playlist-input');
    const value = input.value.trim();
    if (!value) return;

    const loading = document.getElementById('external-loading');
    const searchResults = document.getElementById('external-search-results');
    loading.classList.remove('hidden');
    searchResults.classList.add('hidden');

    // Determine if this looks like a URL/URI or a search query
    const looksLikeUrl = value.includes('spotify.com/playlist/')
        || value.startsWith('spotify:playlist:')
        || /^[a-zA-Z0-9]{22}$/.test(value);

    const body = looksLikeUrl
        ? { url: value }
        : { query: value };

    fetch('/workshop/load-external-playlist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify(body),
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to load playlist.');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.mode === 'tracks') {
            displayExternalTracks(data.playlist, data.tracks);
            showNotification(
                'Loaded "' + data.playlist.name + '" (' + data.tracks.length + ' tracks)',
                'success'
            );
            input.value = '';
        } else if (data.success && data.mode === 'restricted') {
            displayRestrictedPlaylist(data.playlist, data.message, data.suggested_search);
            input.value = '';
        } else if (data.success && data.mode === 'search') {
            displayExternalSearchResults(data.playlists);
        } else {
            showNotification(data.message || 'Unexpected response.', 'error');
        }
    })
    .catch(error => {
        console.error('External playlist load error:', error);
        showNotification(error.message || 'Failed to load playlist.', 'error');
    })
    .finally(() => {
        loading.classList.add('hidden');
    });
}

function loadExternalById(playlistId) {
    const input = document.getElementById('external-playlist-input');
    input.value = playlistId;
    loadExternalPlaylist();
}

function displayExternalSearchResults(playlists) {
    const container = document.getElementById('external-search-results');
    container.innerHTML = '';

    if (!playlists || playlists.length === 0) {
        container.innerHTML = '<p class="text-white/50 text-sm py-2">No playlists found.</p>';
        container.classList.remove('hidden');
        return;
    }

    playlists.forEach(function(pl) {
        const btn = document.createElement('button');
        btn.className = 'w-full flex items-center px-2 py-2 rounded-lg hover:bg-white/10 transition duration-150 text-left';
        btn._playlistId = pl.id;
        btn.addEventListener('click', function() {
            loadExternalById(this._playlistId);
            container.classList.add('hidden');
        });

        const imgHtml = pl.image_url
            ? '<img src="' + escapeHtml(pl.image_url) + '" alt="" class="w-8 h-8 rounded flex-shrink-0 object-cover">'
            : '<div class="w-8 h-8 rounded flex-shrink-0 bg-white/10 flex items-center justify-center text-white/30">' +
                  '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>' +
              '</div>';

        const isNonOwned = pl.owner_id && pl.owner_id !== workshopState.currentUserId;
        const lockIcon = isNonOwned
            ? '<svg class="w-3 h-3 inline-block ml-1 text-yellow-400/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>' +
              '</svg>'
            : '';

        btn.innerHTML =
            imgHtml +
            '<div class="ml-2 min-w-0 flex-1">' +
                '<p class="text-white text-sm font-medium truncate">' + escapeHtml(pl.name) + lockIcon + '</p>' +
                '<p class="text-white/50 text-xs truncate">' + escapeHtml(pl.owner_display_name) + ' &middot; ' + pl.total_tracks + ' tracks</p>' +
            '</div>';
        container.appendChild(btn);
    });

    container.classList.remove('hidden');
}

function displayRestrictedPlaylist(playlistInfo, message, suggestedSearch) {
    const container = document.getElementById('external-search-results');
    if (!container) return;

    container.innerHTML =
        '<div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-6 text-center">' +
            '<svg class="w-12 h-12 mx-auto mb-3 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>' +
            '</svg>' +
            '<h3 class="text-lg font-semibold text-white mb-1">' + escapeHtml(playlistInfo.name) + '</h3>' +
            '<p class="text-sm text-white/50 mb-3">' + (playlistInfo.track_count || 0) + ' tracks</p>' +
            '<p class="text-sm text-white/70 mb-4">' + escapeHtml(message) + '</p>' +
            '<button onclick="suggestSearch(\'' + escapeHtml(suggestedSearch).replace(/'/g, "\\'") + '\')" ' +
                'class="px-4 py-2 bg-yellow-500/20 hover:bg-yellow-500/30 border border-yellow-500/40 rounded-lg text-yellow-300 text-sm transition-colors">' +
                'Search for &ldquo;' + escapeHtml(suggestedSearch) + '&rdquo; tracks' +
            '</button>' +
        '</div>';
    container.classList.remove('hidden');
}

function suggestSearch(query) {
    const searchInput = document.getElementById('spotify-search-input');
    if (searchInput) {
        searchInput.value = query;
        searchInput.dispatchEvent(new Event('input'));
        searchSpotify();
    }
}

function displayExternalTracks(playlistInfo, tracks) {
    // Integrate with Phase 3's source panel by setting state and rendering
    workshopState.sourcePlaylistId = playlistInfo.id;
    workshopState.sourcePlaylistName = playlistInfo.name;
    workshopState.sourceTracks = tracks;

    // Register all tracks in trackDataByUri
    tracks.forEach(function(track) {
        if (!trackDataByUri[track.uri]) {
            trackDataByUri[track.uri] = {
                id: track.id,
                name: track.name,
                artists: track.artists || [],
                album_name: track.album_name || '',
                album_image_url: track.album_image_url || '',
                duration_ms: track.duration_ms || 0,
                uri: track.uri,
            };
        }
    });

    // Ensure source panel is visible
    const body = document.getElementById('source-panel-body');
    if (body.classList.contains('hidden')) {
        toggleSourcePanel();
    }

    // Render using Phase 3's existing function
    renderSourceTracks();
}
</script>

<script>
// =============================================================================
// Workshop Powertools Sidebar
// Self-contained namespace -- does NOT modify any existing workshopState,
// SortableJS, or search functionality.
// =============================================================================

const workshopSidebar = {
    isOpen: false,
    activeTab: null,
    _animating: false,

    /** Safely read from localStorage (handles disabled/full storage). */
    _getStorage(key) {
        try { return localStorage.getItem(key); } catch (e) { return null; }
    },

    /** Safely write to localStorage (handles disabled/full storage). */
    _setStorage(key, value) {
        try { localStorage.setItem(key, value); } catch (e) { /* silent */ }
    },

    /** Initialize sidebar on page load. */
    init() {
        // Restore collapsed/open state from localStorage
        const savedState = this._getStorage('shuffify_sidebar_open');
        const savedTab = this._getStorage('shuffify_sidebar_tab');

        if (savedState === 'true') {
            this.open(savedTab || 'snapshots', false);
        }

        // Close sidebar on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isOpen) {
                this.close();
            }
        });
    },

    /** Toggle sidebar open/closed. */
    toggle() {
        if (this._animating) return;
        if (this.isOpen) {
            this.close();
        } else {
            this.open(this.activeTab || 'snapshots');
        }
    },

    /**
     * Open the sidebar, optionally selecting a tab.
     * @param {string} tabName - Tab to activate (snapshots|archive|raids|schedules)
     * @param {boolean} animate - Whether to animate the transition (default true)
     */
    open(tabName, animate) {
        if (typeof animate === 'undefined') animate = true;
        const panel = document.getElementById('sidebar-panel');
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        const backdrop = document.getElementById('sidebar-backdrop');

        if (animate) {
            this._animating = true;
            setTimeout(() => { this._animating = false; }, 300);
        }

        // Show panel
        panel.classList.remove('translate-x-full');
        panel.setAttribute('aria-hidden', 'false');

        // Hide toggle button
        toggleBtn.classList.add('opacity-0', 'pointer-events-none');
        toggleBtn.setAttribute('aria-expanded', 'true');

        // Show backdrop on mobile
        backdrop.classList.remove('hidden');
        // Force reflow before adding opacity for transition
        void backdrop.offsetWidth;
        backdrop.classList.add('opacity-100');
        backdrop.classList.remove('opacity-0');

        this.isOpen = true;
        this.switchTab(tabName || 'snapshots');

        // Persist state
        this._setStorage('shuffify_sidebar_open', 'true');
    },

    /** Close the sidebar. */
    close() {
        if (this._animating) return;
        this._animating = true;

        const panel = document.getElementById('sidebar-panel');
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        const backdrop = document.getElementById('sidebar-backdrop');

        // Hide panel
        panel.classList.add('translate-x-full');
        panel.setAttribute('aria-hidden', 'true');

        // Show toggle button
        toggleBtn.classList.remove('opacity-0', 'pointer-events-none');
        toggleBtn.setAttribute('aria-expanded', 'false');

        // Hide backdrop
        backdrop.classList.remove('opacity-100');
        backdrop.classList.add('opacity-0');
        setTimeout(() => {
            backdrop.classList.add('hidden');
        }, 300);

        this.isOpen = false;

        // Persist state
        this._setStorage('shuffify_sidebar_open', 'false');

        setTimeout(() => { this._animating = false; }, 300);
    },

    /**
     * Switch to a specific tab.
     * @param {string} tabName - Tab to activate
     */
    switchTab(tabName) {
        // Deactivate all tabs
        document.querySelectorAll('.sidebar-tab-btn').forEach(btn => {
            btn.classList.remove('bg-white/20', 'text-white');
            btn.classList.add('text-white/40');
            btn.setAttribute('aria-selected', 'false');
        });

        // Hide all tab content
        document.querySelectorAll('.sidebar-tab-content').forEach(panel => {
            panel.classList.add('hidden');
        });

        // Activate selected tab button
        const activeBtn = document.querySelector('.sidebar-tab-btn[data-tab="' + tabName + '"]');
        if (activeBtn) {
            activeBtn.classList.add('bg-white/20', 'text-white');
            activeBtn.classList.remove('text-white/40');
            activeBtn.setAttribute('aria-selected', 'true');
        }

        // Show selected tab content
        const activePanel = document.getElementById('sidebar-tab-' + tabName);
        if (activePanel) {
            activePanel.classList.remove('hidden');
        }

        this.activeTab = tabName;
        this._setStorage('shuffify_sidebar_tab', tabName);

        // Fire tab activation hooks for lazy-loading (Phases 2-5)
        if (tabName === 'snapshots' && typeof onSnapshotsTabActivated === 'function') {
            onSnapshotsTabActivated();
        }
        if (tabName === 'archive' && typeof onArchiveTabActivated === 'function') {
            onArchiveTabActivated();
        }
        if (tabName === 'raids' && typeof onRaidsTabActivated === 'function') {
            onRaidsTabActivated();
        }
        if (tabName === 'schedules' && typeof onSchedulesTabActivated === 'function') {
            onSchedulesTabActivated();
        }
    },
};

// Initialize sidebar after DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    workshopSidebar.init();
});
</script>

<script>
// =============================================================================
// Snapshot Browser Panel
// Surfaces the existing snapshot API in the workshop sidebar Snapshots tab.
// =============================================================================

const snapshotState = {
    isLoaded: false,
    isCreating: false,
    snapshots: [],
    pendingRestoreId: null,
    pendingDeleteId: null,
};

const SNAPSHOT_TYPE_CONFIG = {
    'auto_pre_shuffle': { label: 'Pre-Shuffle', color: 'bg-blue-500/20 text-blue-300' },
    'auto_pre_raid': { label: 'Pre-Raid', color: 'bg-yellow-500/20 text-yellow-300' },
    'auto_pre_commit': { label: 'Pre-Commit', color: 'bg-purple-500/20 text-purple-300' },
    'manual': { label: 'Manual', color: 'bg-green-500/20 text-green-300' },
    'scheduled_pre_execution': { label: 'Scheduled', color: 'bg-orange-500/20 text-orange-300' },
};

function formatRelativeTime(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHr = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHr / 24);

    if (diffSec < 60) return 'just now';
    if (diffMin < 60) return diffMin + 'm ago';
    if (diffHr < 24) return diffHr + 'h ago';
    if (diffDay < 7) return diffDay + 'd ago';
    return date.toLocaleDateString();
}

function formatFullDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString();
}

function loadSnapshots() {
    const loadingEl = document.getElementById('snapshot-loading');
    const errorEl = document.getElementById('snapshot-error');
    const emptyEl = document.getElementById('snapshot-empty');
    const timelineEl = document.getElementById('snapshot-timeline');

    loadingEl.classList.remove('hidden');
    errorEl.classList.add('hidden');
    emptyEl.classList.add('hidden');
    timelineEl.classList.add('hidden');

    fetch('/playlist/' + workshopState.playlistId + '/snapshots?limit=50', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
    .then(function(response) {
        if (!response.ok) {
            if (response.status === 401) throw new Error('Session expired. Please log in again.');
            throw new Error('Failed to load snapshots');
        }
        return response.json();
    })
    .then(function(data) {
        loadingEl.classList.add('hidden');
        snapshotState.snapshots = data.snapshots || [];
        snapshotState.isLoaded = true;

        if (snapshotState.snapshots.length === 0) {
            emptyEl.classList.remove('hidden');
        } else {
            renderSnapshotTimeline();
            timelineEl.classList.remove('hidden');
        }
    })
    .catch(function(error) {
        loadingEl.classList.add('hidden');
        var errMsg = document.getElementById('snapshot-error-message');
        errMsg.textContent = error.message;
        errorEl.classList.remove('hidden');
    });
}

function renderSnapshotTimeline() {
    var listEl = document.getElementById('snapshot-list');
    var currentCount = workshopState.workingUris.length;
    var html = '';

    snapshotState.snapshots.forEach(function(snap) {
        var typeConfig = SNAPSHOT_TYPE_CONFIG[snap.snapshot_type] || { label: snap.snapshot_type, color: 'bg-white/10 text-white/50' };
        var diff = snap.track_count - currentCount;
        var diffText = '';
        if (diff > 0) diffText = '<span class="text-green-400 text-xs">+' + diff + ' vs current</span>';
        else if (diff < 0) diffText = '<span class="text-red-400 text-xs">' + diff + ' vs current</span>';
        else diffText = '<span class="text-white/30 text-xs">same as current</span>';

        var description = snap.trigger_description || '';
        var descHtml = description ? '<p class="text-white/40 text-xs mt-1 truncate" title="' + description.replace(/"/g, '&quot;') + '">' + description + '</p>' : '';

        html += '<div class="snapshot-card rounded-lg bg-white/5 border border-white/10 p-3 hover:bg-white/8 transition duration-150">'
            + '<div class="flex items-start justify-between gap-2">'
            + '<div class="min-w-0 flex-1">'
            + '<div class="flex items-center gap-2 mb-1">'
            + '<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold ' + typeConfig.color + '">' + typeConfig.label + '</span>'
            + '<span class="text-white/30 text-xs">' + formatRelativeTime(snap.created_at) + '</span>'
            + '</div>'
            + '<div class="flex items-center gap-2 text-sm">'
            + '<span class="text-white/70">' + snap.track_count + ' tracks</span>'
            + diffText
            + '</div>'
            + descHtml
            + '</div>'
            + '<div class="flex items-center gap-1 flex-shrink-0">'
            + '<button onclick="showRestoreModal(' + snap.id + ', ' + snap.track_count + ')" class="p-1.5 rounded-md text-white/30 hover:text-blue-400 hover:bg-blue-500/10 transition duration-150" title="Restore this snapshot">'
            + '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>'
            + '</button>'
            + '<button onclick="showDeleteModal(' + snap.id + ')" class="p-1.5 rounded-md text-white/30 hover:text-red-400 hover:bg-red-500/10 transition duration-150" title="Delete this snapshot">'
            + '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>'
            + '</button>'
            + '</div>'
            + '</div>'
            + '</div>';
    });

    listEl.innerHTML = html;
}

// --- Manual Snapshot Creation ---

function openManualSnapshotDialog() {
    document.getElementById('snapshot-create-form').classList.remove('hidden');
    document.getElementById('snapshot-description-input').value = '';
    document.getElementById('snapshot-description-input').focus();
}

function cancelManualSnapshot() {
    document.getElementById('snapshot-create-form').classList.add('hidden');
}

function confirmManualSnapshot() {
    if (snapshotState.isCreating) return;
    snapshotState.isCreating = true;

    var desc = document.getElementById('snapshot-description-input').value.trim();

    fetch('/playlist/' + workshopState.playlistId + '/snapshots', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({
            playlist_name: workshopState.playlistName,
            track_uris: workshopState.workingUris,
            trigger_description: desc || 'Manual snapshot',
        }),
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(data) { throw new Error(data.message || 'Failed to create snapshot'); });
        }
        return response.json();
    })
    .then(function(data) {
        cancelManualSnapshot();
        showNotification('Snapshot created', 'success');
        loadSnapshots();
    })
    .catch(function(error) {
        showNotification(error.message || 'Failed to create snapshot', 'error');
    })
    .finally(function() {
        snapshotState.isCreating = false;
    });
}

// --- Restore Modal ---

function showRestoreModal(snapshotId, trackCount) {
    snapshotState.pendingRestoreId = snapshotId;
    var detail = document.getElementById('restore-modal-detail');
    detail.textContent = 'Snapshot has ' + trackCount + ' tracks. Current playlist has ' + workshopState.workingUris.length + ' tracks.';
    document.getElementById('snapshot-restore-modal').classList.remove('hidden');
}

function hideRestoreModal() {
    document.getElementById('snapshot-restore-modal').classList.add('hidden');
    snapshotState.pendingRestoreId = null;
}

function executeRestore() {
    if (!snapshotState.pendingRestoreId) return;

    fetch('/snapshots/' + snapshotState.pendingRestoreId + '/restore', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(data) { throw new Error(data.message || 'Restore failed'); });
        }
        return response.json();
    })
    .then(function(data) {
        hideRestoreModal();
        showNotification('Snapshot restored! Reloading...', 'success');
        setTimeout(function() { window.location.reload(); }, 1000);
    })
    .catch(function(error) {
        hideRestoreModal();
        showNotification(error.message || 'Failed to restore snapshot', 'error');
    });
}

// --- Delete Modal ---

function showDeleteModal(snapshotId) {
    snapshotState.pendingDeleteId = snapshotId;
    document.getElementById('snapshot-delete-modal').classList.remove('hidden');
}

function hideDeleteModal() {
    document.getElementById('snapshot-delete-modal').classList.add('hidden');
    snapshotState.pendingDeleteId = null;
}

function executeDelete() {
    if (!snapshotState.pendingDeleteId) return;

    fetch('/snapshots/' + snapshotState.pendingDeleteId, {
        method: 'DELETE',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(data) { throw new Error(data.message || 'Delete failed'); });
        }
        return response.json();
    })
    .then(function(data) {
        hideDeleteModal();
        showNotification('Snapshot deleted', 'success');
        loadSnapshots();
    })
    .catch(function(error) {
        hideDeleteModal();
        showNotification(error.message || 'Failed to delete snapshot', 'error');
    });
}

// --- Tab Activation Hook (called by Phase 1's switchTab) ---

function onSnapshotsTabActivated() {
    if (!snapshotState.isLoaded) {
        loadSnapshots();
    }
}
</script>

<!-- Archive Playlist Pairing (Phase 3) -->
<script>
// =============================================================================
// Archive Pairing State & Functions
// =============================================================================

var archiveState = {
    isLoaded: false,
    isLoadingTracks: false,
};

function loadArchivePairInfo() {
    var loading = document.getElementById('archive-loading');
    var noPair = document.getElementById('archive-no-pair');
    var paired = document.getElementById('archive-paired');
    var errorEl = document.getElementById('archive-error');

    loading.classList.remove('hidden');
    noPair.classList.add('hidden');
    paired.classList.add('hidden');
    errorEl.classList.add('hidden');

    fetch('/playlist/' + workshopState.playlistId + '/pair')
    .then(function(response) {
        if (!response.ok) throw new Error('Failed to load pair info');
        return response.json();
    })
    .then(function(data) {
        loading.classList.add('hidden');
        if (data.paired) {
            workshopState.archivePair = data.pair;
            renderArchivePanel();
            loadArchiveTracks();
        } else {
            workshopState.archivePair = null;
            noPair.classList.remove('hidden');
        }
        archiveState.isLoaded = true;
    })
    .catch(function(error) {
        loading.classList.add('hidden');
        errorEl.classList.remove('hidden');
        console.error('Archive pair load error:', error);
    });
}

function renderArchivePanel() {
    var noPair = document.getElementById('archive-no-pair');
    var paired = document.getElementById('archive-paired');
    noPair.classList.add('hidden');

    if (!workshopState.archivePair) {
        noPair.classList.remove('hidden');
        paired.classList.add('hidden');
        return;
    }

    var nameEl = document.getElementById('archive-pair-name');
    nameEl.textContent = workshopState.archivePair.archive_playlist_name || 'Archive';
    paired.classList.remove('hidden');
}

function createArchivePair() {
    var btn = event.target.closest('button');
    var originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Creating...';

    fetch('/playlist/' + workshopState.playlistId + '/pair', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({
            create_new: true,
            production_playlist_name: workshopState.playlistName,
        }),
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(d) {
                throw new Error(d.message || 'Failed to create pair');
            });
        }
        return response.json();
    })
    .then(function(data) {
        workshopState.archivePair = data.pair;
        renderArchivePanel();
        loadArchiveTracks();
        showNotification('Archive pair created!', 'success');
    })
    .catch(function(error) {
        btn.disabled = false;
        btn.textContent = originalText;
        showNotification(error.message || 'Failed to create archive pair', 'error');
    });
}

function deleteArchivePair() {
    if (!workshopState.archivePair) return;

    if (!confirm('Remove the archive pairing? The archive playlist itself will NOT be deleted.')) {
        return;
    }

    fetch('/playlist/' + workshopState.playlistId + '/pair', {
        method: 'DELETE',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(d) {
                throw new Error(d.message || 'Failed to remove pair');
            });
        }
        return response.json();
    })
    .then(function() {
        workshopState.archivePair = null;
        workshopState.archiveTracks = [];
        workshopState.archiveQueue = [];
        updateArchiveQueueBadge();
        renderArchivePanel();
        showNotification('Archive pairing removed', 'success');
    })
    .catch(function(error) {
        showNotification(error.message || 'Failed to remove pair', 'error');
    });
}

function loadArchiveTracks() {
    if (!workshopState.archivePair) return;
    archiveState.isLoadingTracks = true;

    var listEl = document.getElementById('archive-track-list');
    var emptyEl = document.getElementById('archive-tracks-empty');
    var countEl = document.getElementById('archive-pair-track-count');

    fetch('/playlist/' + workshopState.playlistId + '/pair/archive-tracks')
    .then(function(response) {
        if (!response.ok) throw new Error('Failed to load archive tracks');
        return response.json();
    })
    .then(function(data) {
        workshopState.archiveTracks = data.tracks || [];
        countEl.textContent = workshopState.archiveTracks.length + ' track' + (workshopState.archiveTracks.length !== 1 ? 's' : '') + ' archived';
        renderArchiveTrackList();
    })
    .catch(function(error) {
        console.error('Archive tracks load error:', error);
        listEl.innerHTML = '';
        emptyEl.classList.add('hidden');
        countEl.textContent = 'Error loading tracks';
    })
    .finally(function() {
        archiveState.isLoadingTracks = false;
    });
}

function renderArchiveTrackList() {
    var listEl = document.getElementById('archive-track-list');
    var emptyEl = document.getElementById('archive-tracks-empty');

    if (!workshopState.archiveTracks || workshopState.archiveTracks.length === 0) {
        listEl.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
    }

    emptyEl.classList.add('hidden');
    var html = '';
    workshopState.archiveTracks.forEach(function(track) {
        var artists = (track.artists || []).join(', ');
        var imgHtml = track.album_image_url
            ? '<img src="' + escapeHtml(track.album_image_url) + '" alt="" class="w-full h-full object-cover" loading="lazy">'
            : '<div class="w-full h-full flex items-center justify-center text-white/30"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55C7.79 13 6 14.79 6 17s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>';

        html += '<div class="archive-track-item flex items-center p-2 rounded-lg hover:bg-white/5 transition duration-150 group">'
            + '<div class="w-8 h-8 rounded overflow-hidden flex-shrink-0 bg-black/20">' + imgHtml + '</div>'
            + '<div class="ml-2 flex-1 min-w-0">'
            + '<p class="text-white text-sm truncate">' + escapeHtml(track.name) + '</p>'
            + '<p class="text-white/40 text-xs truncate">' + escapeHtml(artists) + '</p>'
            + '</div>'
            + '<button onclick="unarchiveTrack(\'' + escapeHtml(track.uri) + '\')" '
            + 'class="ml-2 p-1.5 rounded-lg text-white/20 hover:text-green-400 hover:bg-white/10 opacity-0 group-hover:opacity-100 transition duration-150 flex-shrink-0" '
            + 'title="Restore to playlist">'
            + '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">'
            + '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a5 5 0 015 5v2M3 10l4-4M3 10l4 4"></path>'
            + '</svg></button>'
            + '</div>';
    });
    listEl.innerHTML = html;
}

function flushArchiveQueue() {
    if (workshopState.archiveQueue.length === 0) return;
    if (!workshopState.archivePair) {
        workshopState.archiveQueue = [];
        updateArchiveQueueBadge();
        return;
    }

    var uris = [...workshopState.archiveQueue];
    workshopState.archiveQueue = [];
    updateArchiveQueueBadge();

    fetch('/playlist/' + workshopState.playlistId + '/pair/archive', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({ track_uris: uris }),
    })
    .then(function(response) {
        if (!response.ok) throw new Error('Archive flush failed');
        return response.json();
    })
    .then(function(data) {
        showNotification('Archived ' + data.archived_count + ' track' + (data.archived_count !== 1 ? 's' : ''), 'info');
        if (archiveState.isLoaded) {
            loadArchiveTracks();
        }
    })
    .catch(function(error) {
        console.error('Archive flush error:', error);
        // Put URIs back in queue so they can be retried
        workshopState.archiveQueue = uris.concat(workshopState.archiveQueue);
        updateArchiveQueueBadge();
        showNotification('Failed to archive removed tracks. They remain queued.', 'error');
    });
}

function unarchiveTrack(uri) {
    if (!workshopState.archivePair) return;

    fetch('/playlist/' + workshopState.playlistId + '/pair/unarchive', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({ track_uris: [uri] }),
    })
    .then(function(response) {
        if (!response.ok) throw new Error('Unarchive failed');
        return response.json();
    })
    .then(function(data) {
        showNotification('Track restored to playlist', 'success');
        loadArchiveTracks();
    })
    .catch(function(error) {
        showNotification(error.message || 'Failed to restore track', 'error');
    });
}

function updateArchiveQueueBadge() {
    var badge = document.getElementById('archive-queue-badge');
    if (!badge) return;
    var count = workshopState.archiveQueue.length;
    if (count > 0) {
        badge.textContent = count + ' queued';
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// --- Tab Activation Hook ---

function onArchiveTabActivated() {
    if (!archiveState.isLoaded) {
        loadArchivePairInfo();
    }
}
</script>

<!-- Smart Raid Panel (Phase 4) -->
<script>
var raidPanel = {
    loaded: false,
    isLoading: false,
    status: null,
    playlistsPopulated: false,

    init: function() {
        this.loadStatus();
    },

    loadStatus: function() {
        var self = this;
        var loading = document.getElementById('raid-loading');
        var content = document.getElementById('raid-panel-content');
        var errorEl = document.getElementById('raid-error');

        loading.classList.remove('hidden');
        content.classList.add('hidden');
        errorEl.classList.add('hidden');
        self.isLoading = true;

        fetch('/playlist/' + workshopState.playlistId + '/raid-status')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to load raid status');
            return response.json();
        })
        .then(function(data) {
            loading.classList.add('hidden');
            self.status = data.raid_status;
            self.loaded = true;
            self.render();
            content.classList.remove('hidden');

            if (!self.playlistsPopulated) {
                self.populatePlaylistDropdown();
            }
        })
        .catch(function(error) {
            loading.classList.add('hidden');
            errorEl.classList.remove('hidden');
            console.error('Raid status load error:', error);
        })
        .finally(function() {
            self.isLoading = false;
        });
    },

    render: function() {
        if (!this.status) return;
        this.renderSources(this.status.sources);
        this.renderSchedule(this.status.schedule);

        var raidNowBtn = document.getElementById('raid-now-btn');
        raidNowBtn.disabled = this.status.source_count === 0;
    },

    renderSources: function(sources) {
        var listEl = document.getElementById('raid-sources-list');
        var emptyEl = document.getElementById('raid-sources-empty');

        if (!sources || sources.length === 0) {
            listEl.innerHTML = '';
            emptyEl.classList.remove('hidden');
            return;
        }

        emptyEl.classList.add('hidden');
        var html = '';
        sources.forEach(function(src) {
            var name = src.source_name || src.source_playlist_id;
            var typeBadge = src.source_type === 'own'
                ? '<span class="px-1.5 py-0.5 rounded-full bg-green-500/20 text-green-300 text-xs">own</span>'
                : '<span class="px-1.5 py-0.5 rounded-full bg-blue-500/20 text-blue-300 text-xs">external</span>';

            html += '<div class="flex items-center p-2 rounded-lg hover:bg-white/5 transition duration-150 group">'
                + '<div class="flex-1 min-w-0">'
                + '<p class="text-white text-sm truncate">' + escapeHtml(name) + '</p>'
                + '<div class="flex items-center gap-1 mt-0.5">' + typeBadge + '</div>'
                + '</div>'
                + '<button onclick="raidPanel.unwatchSource(' + src.id + ')" '
                + 'class="ml-2 p-1.5 rounded-lg text-white/20 hover:text-red-400 hover:bg-white/10 opacity-0 group-hover:opacity-100 transition duration-150 flex-shrink-0" '
                + 'title="Remove source">'
                + '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">'
                + '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>'
                + '</svg></button>'
                + '</div>';
        });
        listEl.innerHTML = html;
    },

    renderSchedule: function(schedule) {
        var infoEl = document.getElementById('raid-schedule-info');
        var noSched = document.getElementById('raid-no-schedule');

        if (!schedule) {
            infoEl.classList.add('hidden');
            noSched.classList.remove('hidden');
            return;
        }

        noSched.classList.add('hidden');
        infoEl.classList.remove('hidden');

        var intervalMap = {
            'every_6h': 'Every 6 hours',
            'every_12h': 'Every 12 hours',
            'daily': 'Every day',
            'every_3d': 'Every 3 days',
            'weekly': 'Every week'
        };
        var intervalEl = document.getElementById('raid-schedule-interval');
        intervalEl.textContent = intervalMap[schedule.schedule_value] || schedule.schedule_value;

        var toggleEl = document.getElementById('raid-schedule-toggle');
        if (schedule.is_enabled) {
            toggleEl.textContent = 'Enabled';
            toggleEl.className = 'px-2 py-0.5 rounded-full text-xs font-semibold bg-green-500/20 text-green-300 transition duration-150';
        } else {
            toggleEl.textContent = 'Disabled';
            toggleEl.className = 'px-2 py-0.5 rounded-full text-xs font-semibold bg-red-500/20 text-red-300 transition duration-150';
        }

        var lastRunEl = document.getElementById('raid-schedule-last-run');
        var badgeEl = document.getElementById('raid-schedule-status-badge');
        if (schedule.last_run_at) {
            lastRunEl.textContent = 'Last run: ' + formatRelativeTime(schedule.last_run_at);
            if (schedule.last_status === 'success') {
                badgeEl.textContent = 'success';
                badgeEl.className = 'px-1.5 py-0.5 rounded-full text-xs font-semibold bg-green-500/20 text-green-300';
            } else if (schedule.last_status === 'failed') {
                badgeEl.textContent = 'failed';
                badgeEl.className = 'px-1.5 py-0.5 rounded-full text-xs font-semibold bg-red-500/20 text-red-300';
            } else {
                badgeEl.textContent = '';
                badgeEl.className = '';
            }
        } else {
            lastRunEl.textContent = 'Never run';
            badgeEl.textContent = '';
            badgeEl.className = '';
        }
    },

    populatePlaylistDropdown: function() {
        var select = document.getElementById('raid-playlist-select');
        var watchBtn = document.getElementById('raid-watch-btn');

        select.addEventListener('change', function() {
            watchBtn.disabled = !select.value;
        });

        // Fetch playlists if not already loaded
        fetch('/user-playlists')
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to fetch playlists');
            return response.json();
        })
        .then(function(data) {
            var playlists = data.playlists || [];
            playlists.forEach(function(pl) {
                if (pl.id === workshopState.playlistId) return;
                var opt = document.createElement('option');
                opt.value = pl.id;
                opt.textContent = pl.name + ' (' + pl.track_count + ' tracks)';
                opt.dataset.name = pl.name;
                select.appendChild(opt);
            });
            raidPanel.playlistsPopulated = true;
        })
        .catch(function(error) {
            console.error('Failed to load playlists for raid:', error);
        });
    },

    watchPlaylist: function() {
        var select = document.getElementById('raid-playlist-select');
        var selectedOption = select.options[select.selectedIndex];
        if (!select.value) return;

        var btn = document.getElementById('raid-watch-btn');
        btn.disabled = true;
        btn.textContent = 'Watching...';

        var self = this;
        fetch('/playlist/' + workshopState.playlistId + '/raid-watch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
                source_playlist_id: select.value,
                source_playlist_name: selectedOption.dataset.name || select.value,
                target_playlist_name: workshopState.playlistName,
                auto_schedule: true,
                schedule_value: 'daily',
            }),
        })
        .then(function(response) {
            if (!response.ok) {
                return response.json().then(function(d) {
                    throw new Error(d.message || 'Failed to watch playlist');
                });
            }
            return response.json();
        })
        .then(function(data) {
            showNotification('Now watching ' + (selectedOption.dataset.name || select.value), 'success');
            select.value = '';
            btn.textContent = 'Watch Playlist';
            btn.disabled = true;
            self.loadStatus();
        })
        .catch(function(error) {
            btn.textContent = 'Watch Playlist';
            btn.disabled = !select.value;
            showNotification(error.message || 'Failed to watch playlist', 'error');
        });
    },

    unwatchSource: function(sourceId) {
        var self = this;

        fetch('/playlist/' + workshopState.playlistId + '/raid-unwatch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({ source_id: sourceId }),
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Failed to remove source');
            return response.json();
        })
        .then(function() {
            showNotification('Source removed', 'success');
            self.loadStatus();
        })
        .catch(function(error) {
            showNotification(error.message || 'Failed to remove source', 'error');
        });
    },

    raidNow: function() {
        var btn = document.getElementById('raid-now-btn');
        var originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Raiding...';

        var self = this;
        fetch('/playlist/' + workshopState.playlistId + '/raid-now', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({}),
        })
        .then(function(response) {
            if (!response.ok) {
                return response.json().then(function(d) {
                    throw new Error(d.message || 'Raid failed');
                });
            }
            return response.json();
        })
        .then(function(data) {
            var msg = 'Raid complete: ' + (data.tracks_added || 0) + ' new tracks added';
            showNotification(msg, 'success');
            self.loadStatus();
        })
        .catch(function(error) {
            showNotification(error.message || 'Raid failed', 'error');
        })
        .finally(function() {
            btn.innerHTML = originalHTML;
            btn.disabled = self.status && self.status.source_count === 0;
        });
    },

    toggleSchedule: function() {
        var self = this;

        fetch('/playlist/' + workshopState.playlistId + '/raid-schedule-toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Toggle failed');
            return response.json();
        })
        .then(function(data) {
            var state = data.schedule.is_enabled ? 'enabled' : 'disabled';
            showNotification('Schedule ' + state, 'success');
            self.loadStatus();
        })
        .catch(function(error) {
            showNotification(error.message || 'Failed to toggle schedule', 'error');
        });
    },
};

function onRaidsTabActivated() {
    if (!raidPanel.loaded) {
        raidPanel.init();
    }
}
</script>

<!-- ==================== Rotation Panel (Phase 5) ==================== -->
<script>
const rotationState = {
    isLoaded: false,
    isLoading: false,
};

function onSchedulesTabActivated() {
    if (!rotationState.isLoaded && !rotationState.isLoading) {
        loadRotationStatus();
    }
}

async function loadRotationStatus() {
    rotationState.isLoading = true;
    const container = document.getElementById('rotation-panel-content');
    container.innerHTML = '<div class="text-center py-4"><div class="inline-block w-6 h-6 border-2 border-white/20 border-t-white/60 rounded-full animate-spin"></div></div>';

    try {
        const response = await fetch('/playlist/' + workshopState.playlistId + '/rotation-status');
        const data = await response.json();

        if (data.success) {
            renderRotationPanel(data);
            rotationState.isLoaded = true;
        } else {
            container.innerHTML = '<p class="text-red-400 text-sm">Failed to load rotation status.</p>';
        }
    } catch (err) {
        container.innerHTML = '<p class="text-red-400 text-sm">Network error loading rotation status.</p>';
    } finally {
        rotationState.isLoading = false;
    }
}

function renderRotationPanel(data) {
    const container = document.getElementById('rotation-panel-content');
    let html = '';

    // Archive Pair Status
    if (data.has_pair && data.pair) {
        html += '<div class="rounded-xl bg-white/5 border border-white/10 p-4 mb-3">';
        html += '<div class="flex items-center gap-2 mb-2">';
        html += '<span class="w-2 h-2 rounded-full bg-green-400"></span>';
        html += '<span class="text-white/80 text-sm font-semibold">Archive Paired</span>';
        html += '</div>';
        html += '<p class="text-white/50 text-xs">Archive: ' + (data.pair.archive_playlist_name || data.pair.archive_playlist_id) + '</p>';
        html += '</div>';
    } else {
        html += '<div class="rounded-xl bg-white/5 border border-white/10 p-4 mb-3">';
        html += '<div class="flex items-center gap-2 mb-2">';
        html += '<span class="w-2 h-2 rounded-full bg-yellow-400"></span>';
        html += '<span class="text-white/60 text-sm font-semibold">No Archive Pair</span>';
        html += '</div>';
        html += '<p class="text-white/40 text-xs">Create an archive pair in the Archive tab to enable rotation.</p>';
        html += '</div>';
    }

    // Active Rotation Schedule
    if (data.has_rotation_schedule && data.rotation_schedule) {
        const sched = data.rotation_schedule;
        const params = sched.algorithm_params || {};
        const mode = (params.rotation_mode || 'archive_oldest').replace(/_/g, ' ');
        const count = params.rotation_count || 5;
        const freq = (sched.schedule_value || 'daily').replace(/_/g, ' ');

        html += '<div class="rounded-xl bg-white/5 border border-white/10 p-4 mb-3">';
        html += '<div class="flex items-center justify-between mb-2">';
        html += '<span class="text-white/80 text-sm font-semibold">Active Rotation</span>';
        if (sched.is_enabled) {
            html += '<span class="px-2 py-0.5 rounded-full bg-green-500/60 text-white text-xs font-bold">Active</span>';
        } else {
            html += '<span class="px-2 py-0.5 rounded-full bg-gray-500/60 text-white/70 text-xs font-bold">Paused</span>';
        }
        html += '</div>';
        html += '<div class="space-y-1 text-xs">';
        html += '<p class="text-white/60"><span class="text-white/40">Mode:</span> <span class="capitalize">' + mode + '</span></p>';
        html += '<p class="text-white/60"><span class="text-white/40">Count:</span> ' + count + ' tracks</p>';
        html += '<p class="text-white/60"><span class="text-white/40">Frequency:</span> <span class="capitalize">' + freq + '</span></p>';

        if (sched.last_run_at) {
            html += '<p class="text-white/40 mt-1">Last run: ' + sched.last_run_at;
            if (sched.last_status === 'success') {
                html += ' <span class="text-green-400">Success</span>';
            } else if (sched.last_status === 'failed') {
                html += ' <span class="text-red-400">Failed</span>';
            }
            html += '</p>';
        }
        html += '</div>';
        html += '</div>';
    } else if (data.has_pair) {
        html += '<div class="rounded-xl bg-white/5 border border-white/10 p-4 mb-3 text-center">';
        html += '<p class="text-white/50 text-sm mb-2">No rotation schedule configured.</p>';
        html += '<a href="/schedules" class="inline-block px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm font-medium transition border border-white/20">';
        html += 'Set Up Rotation</a>';
        html += '</div>';
    }

    container.innerHTML = html;
}
</script>

<style>
.workshop-scrollbar::-webkit-scrollbar { width: 8px; }
.workshop-scrollbar::-webkit-scrollbar-thumb { background: rgba(20, 120, 60, 0.5); border-radius: 6px; }
.workshop-scrollbar::-webkit-scrollbar-track { background: transparent; }
.workshop-scrollbar { scrollbar-color: rgba(20, 120, 60, 0.5) transparent; scrollbar-width: thin; }

.sortable-ghost { opacity: 0.4; background: rgba(29, 185, 84, 0.2) !important; border-radius: 8px; }
.sortable-chosen { background: rgba(255, 255, 255, 0.08) !important; }
.sortable-drag { background: rgba(29, 185, 84, 0.3) !important; border-radius: 8px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }

.rotate-180 { transform: rotate(180deg); }
.source-track-item { background: rgba(255, 255, 255, 0.02); }
.source-track-item:hover { background: rgba(255, 255, 255, 0.06); }

/* Snapshot Browser Panel */
.snapshot-card:hover { background: rgba(255, 255, 255, 0.08) !important; }
.snapshot-timeline-container { max-height: calc(100vh - 200px); overflow-y: auto; }
.snapshot-timeline-fade {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.4));
}

/* Workshop Powertools Sidebar */
.sidebar-scrollbar::-webkit-scrollbar { width: 6px; }
.sidebar-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 6px; }
.sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
.sidebar-scrollbar { scrollbar-color: rgba(255, 255, 255, 0.15) transparent; scrollbar-width: thin; }

#sidebar-toggle-btn {
    transition: opacity 0.2s ease, background-color 0.2s ease;
}

/* On mobile/tablet, sidebar overlays the full viewport width area */
@media (max-width: 1023px) {
    #sidebar-panel {
        box-shadow: -8px 0 32px rgba(0, 0, 0, 0.5);
    }
}

/* On desktop (lg+), sidebar sits alongside content without backdrop */
@media (min-width: 1024px) {
    #sidebar-panel {
        box-shadow: -4px 0 16px rgba(0, 0, 0, 0.3);
    }
}
</style>
{% endblock %}
