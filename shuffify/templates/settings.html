{% extends "base.html" %}
{% from "macros/cards.html" import glass_card %}
{% from "macros/forms.html" import select_field, toggle_field %}

{% block title %}Settings - Shuffify{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-spotify-green via-spotify-green/90 to-spotify-dark">
    <div class="absolute inset-0" style="background-image: url('/static/images/hero-pattern.svg'); opacity: 0.15; pointer-events: none;"></div>

    <!-- Header -->
    <div class="relative max-w-3xl mx-auto px-4 pt-8">
        {% call glass_card() %}
            <div class="flex items-center">
                <a href="{{ url_for('main.index') }}"
                   class="mr-4 p-2 rounded-lg bg-white/10 hover:bg-white/20 transition duration-150 border border-white/20"
                   title="Back to Dashboard">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <div>
                    <h1 class="text-2xl font-bold text-white">Settings</h1>
                    <p class="text-white/70 text-sm">Customize your Shuffify experience</p>
                </div>
            </div>
        {% endcall %}
    </div>

    <!-- Settings Form -->
    <div class="relative max-w-3xl mx-auto px-4 py-6">
        <form id="settings-form" method="POST" action="{{ url_for('main.update_settings') }}" class="space-y-6">

            <!-- Shuffle Defaults Section -->
            {% call glass_card('Shuffle Defaults') %}
                <div class="space-y-4">
                    {{ select_field(
                        label='Default Shuffle Algorithm',
                        field_id='default_algorithm',
                        field_name='default_algorithm',
                        options=[{'value': '', 'label': 'No default (choose each time)'}] + [
                            {'value': algo.class_name, 'label': algo.name}
                            for algo in algorithms
                        ],
                        selected=settings.default_algorithm or '',
                        help_text='Pre-selects this algorithm when shuffling playlists.'
                    ) }}
                </div>
            {% endcall %}

            <!-- Appearance Section -->
            {% call glass_card('Appearance') %}
                {{ select_field(
                    label='Theme',
                    field_id='theme',
                    field_name='theme',
                    options=[
                        {'value': 'system', 'label': 'System (follow OS setting)'},
                        {'value': 'light', 'label': 'Light'},
                        {'value': 'dark', 'label': 'Dark'}
                    ],
                    selected=settings.theme,
                    help_text='Theme support is planned for a future release.'
                ) }}
            {% endcall %}

            <!-- Snapshots & History Section -->
            {% call glass_card('Snapshots &amp; History') %}
                <div class="space-y-4">
                    {{ toggle_field(
                        label='Auto-snapshot before shuffle',
                        field_id='auto_snapshot_enabled',
                        field_name='auto_snapshot_enabled',
                        checked=settings.auto_snapshot_enabled,
                        description='Automatically save playlist state before each shuffle.'
                    ) }}

                    <!-- Max Snapshots (number input - only one usage, not macro-worthy) -->
                    <div>
                        <label for="max_snapshots_per_playlist" class="block text-sm font-medium text-white/90 mb-1">
                            Max snapshots per playlist
                        </label>
                        <input type="number" id="max_snapshots_per_playlist" name="max_snapshots_per_playlist"
                               value="{{ settings.max_snapshots_per_playlist }}"
                               min="1" max="50"
                               class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-white/30 focus:border-transparent">
                        <p class="mt-1 text-xs text-white/50">
                            Oldest snapshots are removed when the limit is reached (1-50).
                        </p>
                    </div>
                </div>
            {% endcall %}

            <!-- Dashboard Section -->
            {% call glass_card('Dashboard') %}
                {{ toggle_field(
                    label='Show recent activity',
                    field_id='dashboard_show_recent_activity',
                    field_name='dashboard_show_recent_activity',
                    checked=settings.dashboard_show_recent_activity,
                    description='Display recent shuffle and raid activity on the dashboard.'
                ) }}
            {% endcall %}

            <!-- Notifications Section -->
            {% call glass_card('Notifications') %}
                {{ toggle_field(
                    label='Enable notifications',
                    field_id='notifications_enabled',
                    field_name='notifications_enabled',
                    checked=settings.notifications_enabled,
                    description='Receive notifications about scheduled operations (coming soon).'
                ) }}
            {% endcall %}

            <!-- Save Button -->
            <div class="flex justify-end">
                <button type="submit"
                        class="px-8 py-3 rounded-lg bg-white text-spotify-dark font-bold transition duration-150 hover:bg-green-100 shadow-lg">
                    Save Settings
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('settings-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';

    const formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(d => {
                throw new Error(d.message || 'Failed to save settings.');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message || 'Save failed.', 'error');
        }
    })
    .catch(error => {
        showNotification(error.message, 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
});
</script>
{% endblock %}
